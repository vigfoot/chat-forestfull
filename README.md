# Chat-Forestfull

실시간 커뮤니티 + 포인트/임시 매니저 기능 + PayPal 결제/환불 시스템

---

## 목차

1. [프로젝트 개요](#1-프로젝트-개요)  
2. [회원가입 / 로그인](#2-회원가입--로그인)  
3. [채팅방](#3-채팅방)  
4. [공지 / 알림](#4-공지--알림)  
5. [멘션 기능](#5-멘션-기능)  
6. [포인트 시스템 & 임시 매니저](#6-포인트-시스템--임시-매니저)  
   - [포인트/결제 흐름](#포인트결제-흐름)  
   - [트랜잭션 처리 예시](#트랜잭션-처리-예시)  
7. [관리자 기능](#7-관리자-기능)  
8. [운영 고려 사항](#8-운영-고려-사항)  

---

## 1. 프로젝트 개요

- 브라우저 기반 접근, TikTok OAuth 연동
- PayPal 국제 결제 지원 (다중 통화, 환율 적용)
- 글로벌 사용자 대상 운영 가능

---

## 2. 회원가입 / 로그인

- TikTok OAuth 전용 로그인
- OAuth 토큰으로 사용자 정보 수집
  - 닉네임, 프로필 이미지, TikTok ID, 팔로우 정보
- 서버에서 JWT 발급
  - 액세스 토큰: 30분
  - 리프레시 토큰: 14일
- 간단한 가입/로그인으로 실시간 커뮤니티 진입 장벽 최소화

---

## 3. 채팅방

- 단일 방, 선별된 사용자만 접근 가능
  - 접근 기준: 팔로우 여부 또는 OAuth 가입 승인
- 메시지 저장: 이전 글 모두 확인 가능
- 신규 가입 사용자 승인 자동화 가능
  - 팔로우 확인 API 사용 또는 관리자가 수동 승인

---

## 4. 공지 / 알림

- 브라우저 푸시 불가 환경 고려
- 공지 표시 방법:
  - 상단 고정 배너 (WebSocket / SSE)
  - 채팅 상단 공지 라인, 배경색 강조
  - 페이지 접근 시 임시 모달 팝업
- 공지 이벤트 WebSocket 브로드캐스트, 클라이언트는 배너/채팅 상단 표시

---

## 5. 멘션 기능

- 무료 사용
- @username 패턴 감지 → 해당 사용자 화면 하이라이트
- DB에는 원본 메시지 + 멘션 필드 저장

---

## 6. 포인트 시스템 & 임시 매니저

- 포인트 구매 순위 1~3위 사용자 → 1주일간 임시 매니저 권한 부여
- 주간 자동 집계
- **임시 매니저 권한**
  - mute 기능: 일반 사용자 대상, 1시간 제한, 주 10회 사용 가능
  - 특별 채팅: 사진+텍스트 업로드 가능
  - 권한 자동 만료: 1주일 후 소멸, 사용 기록 저장

### 포인트/결제 흐름

1. **결제 완료**
   - PayPal Sandbox / Production 승인
   - DB에 결제 기록 저장 (상태: SUCCESS)
   - 포인트 지급
   - 주간 상위 포인트 구매자 순위 집계 → 임시 매니저 권한 부여

2. **결제 취소 / 환불**
   - PayPal Webhook 이벤트 수신 (`PAYMENT.CAPTURE.REFUNDED` 등)
   - DB 업데이트:
     - 포인트 차감
     - 임시 매니저 권한 회수
       - 이미 사용한 권한은 기록으로 남김
       - 추가 사용 제한
   - 사용자 알림 발송 (채팅 내 공지 또는 모달)

3. **권한 만료**
   - 주 단위 집계 후 자동 소멸
   - 사용 기록 감사 로그에 저장

### 트랜잭션 처리 예시

```java
@Transactional
public void handleRefund(String transactionId) {
    Payment payment = paymentRepository.findByTransactionId(transactionId);
    if(payment == null || !payment.getStatus().equals("SUCCESS")) return;

    User user = payment.getUser();
    user.decreasePoints(payment.getAmount());

    if(user.hasTemporaryManagerRole()) {
        user.revokeTemporaryManagerRole();
    }

    auditLogRepository.save(new AuditLog(user, "Refund processed", LocalDateTime.now()));
    userRepository.save(user);
}
```

---

## 7. 관리자 기능

- 사용자 관리: 가입 승인/접근 제한, 경고, 강퇴, mute, 임시 매니저 권한 발급/회수
- 채팅 모니터링: 실시간 메시지 스트림 확인, 금칙어 필터링, 악성 메시지 감지
- 공지 발행: 상단 배너, 채팅 상단, 모달 팝업
- 포인트/결제 관리: 결제 로그 확인, 포인트 구매 순위 확인
- 시스템 로그/감사: 임시 매니저 사용 내역, 채팅 삭제/관리 기록
- 백업/DB 관리: 채팅 기록 백업, 이미지 업로드 파일 관리

---

## 8. 운영 고려 사항

- 채팅방 접근 제어: 팔로우 기준 자동 승인 → 운영 부담 최소화
- 공지 표시: 상단 배너 + SSE/WS, 중요 내용 클릭 시 모달
- 임시 매니저 남용 방지: 주 10회, 1시간 mute, 로그 기록으로 책임 추적
- 이미지 업로드: 특별 채팅에서만 가능, 클라우드 스토리지(AWS S3 등) 권장
- 국제 결제/환불 처리: 다양한 통화 지원, 환율 적용, 원 결제 수단 환불, 처리 지연 안내
