<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emoji ê´€ë¦¬</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        h1 { text-align: center; }
        #emoji-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; justify-content: center; }
        .emoji-item { position: relative; width: 100px; height: 100px; border: 1px solid #ccc; border-radius: 8px; display: flex; align-items: center; justify-content: center; background:#fff; box-shadow:0 2px 4px rgba(0,0,0,0.1);}
        .emoji-item img { max-width: 90%; max-height: 90%; border-radius:4px;}
        .delete-btn { position: absolute; top: 2px; right: 2px; background: red; color: #fff; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-weight:bold; line-height: 18px; }

        #drop-zone { border: 2px dashed #aaa; padding: 20px; text-align: center; cursor: pointer; border-radius: 8px; background:#fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
        #drop-zone.hover { border-color: #333; }

        #canvas-popup { display:none; position: fixed; top:50%; left:50%; transform: translate(-50%, -50%); background:#fff; padding: 20px; z-index:1001; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,0.3);}
        #popup-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index:1000;}
        canvas { border:1px solid #ccc; touch-action: none; display:block; margin:auto; }

        .control-panel { margin-top:10px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;}
        .control-panel label { display:flex; flex-direction:column; align-items:center; font-size:12px;}
        .control-panel input[type="color"], .control-panel input[type="range"] { margin-top:5px; }

        .template-btn { background:#007bff; color:#fff; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;}
        .template-btn:hover { background:#0056b3;}
    </style>
</head>
<body>

<h1>Emoji ê´€ë¦¬</h1>

<div id="drop-zone">ì—¬ê¸°ì— ì´ë¯¸ì§€ ë“œë˜ê·¸ ë˜ëŠ” í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
<div id="emoji-list"></div>

<div id="popup-overlay"></div>
<div id="canvas-popup">
    <canvas id="emoji-canvas" width="512" height="512"></canvas>
    <div class="control-panel">

        <!-- ğŸ”¥ íˆ¬ëª… or ë°°ê²½ìƒ‰ ì„ íƒ ì¶”ê°€ë¨ -->
        <label>
            ë°°ê²½ ì²˜ë¦¬
            <div style="display:flex; gap:5px; margin-top:5px;">
                <label><input type="radio" name="bgOption" value="transparent" checked> íˆ¬ëª…</label>
                <label><input type="radio" name="bgOption" value="color"> ìƒ‰ìƒ</label>
            </div>
            <input type="color" id="bg-color" value="#ffffff" disabled>
        </label>

        <label>íšŒì „<input type="range" id="rotate" min="0" max="360" value="0"></label>
        <label>ì¢Œìš°ë°˜ì „<button id="flip">â†”</button></label>
        <label>ë°ê¸°<input type="range" id="brightness" min="0" max="200" value="100"></label>
        <label>ëŒ€ë¹„<input type="range" id="contrast" min="0" max="200" value="100"></label>
        <label>ì±„ë„<input type="range" id="saturation" min="0" max="200" value="100"></label>
        <label>í…œí”Œë¦¿<button class="template-btn" id="template-256">256px</button></label>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; justify-content:center;">
        <button id="confirm-btn">í™•ì¸</button>
        <button id="cancel-btn">ì·¨ì†Œ</button>
    </div>
</div>

<input type="file" id="file-input" accept="image/*" style="display:none;">

<script>
    const emojiList = document.getElementById('emoji-list');
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const popup = document.getElementById('canvas-popup');
    const overlay = document.getElementById('popup-overlay');
    const canvas = document.getElementById('emoji-canvas');
    const ctx = canvas.getContext('2d');

    const confirmBtn = document.getElementById('confirm-btn');
    const cancelBtn = document.getElementById('cancel-btn');

    const bgColorInput = document.getElementById('bg-color');
    const bgOption = document.getElementsByName('bgOption');
    const rotateInput = document.getElementById('rotate');
    const flipBtn = document.getElementById('flip');
    const brightnessInput = document.getElementById('brightness');
    const contrastInput = document.getElementById('contrast');
    const saturationInput = document.getElementById('saturation');
    const templateBtn = document.getElementById('template-256');

    let backgroundTransparent = true;
    let backgroundColor = "#ffffff";

    bgOption.forEach(option => {
        option.addEventListener("change", () => {
            if(option.value === "transparent"){
                backgroundTransparent = true;
                bgColorInput.disabled = true;
            } else {
                backgroundTransparent = false;
                bgColorInput.disabled = false;
            }
            drawCanvas();
        });
    });

    bgColorInput.addEventListener("input", (e)=>{
        backgroundColor = e.target.value;
        if(!backgroundTransparent) drawCanvas();
    });

    let uploadedFile = null;
    let img = new Image();
    let imgLoaded = false;

    let selection = { x:0, y:0, size:256 };
    let dragging = false;
    let resizing = false;
    let currentHandle = null;
    let startPos = {x:0, y:0};

    let rotate = 0, flipped=false, brightness=100, contrast=100, saturation=100;

    function fetchEmojiList(){
        fetch('/file/emoji')
            .then(res => res.json())
            .then(data => {
                const list = Array.isArray(data) ? data : (data?.body || []);
                emojiList.innerHTML = '';
                list.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'emoji-item';
                    const image = document.createElement('img');
                    image.src = item.directory ? `/file/emoji/resource/${encodeURIComponent(item.directory)}` : '';
                    div.appendChild(image);

                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'X';
                    delBtn.className = 'delete-btn';
                    delBtn.onclick = () => deleteEmoji(item.id);
                    div.appendChild(delBtn);

                    emojiList.appendChild(div);
                });
            }).catch(err=>console.error(err));
    }

    function deleteEmoji(id){
        fetch(`/admin/emoji/${id}`, { method:'DELETE' })
            .then(res=>res.json())
            .then(data=>{ if(data?.success) fetchEmojiList(); else alert(data?.message || 'ì‚­ì œ ì‹¤íŒ¨'); })
            .catch(err=>{ console.error(err); alert('ì‚­ì œ ì‹¤íŒ¨ (ì„œë²„ ì˜¤ë¥˜)'); });
    }

    dropZone.addEventListener('click', ()=>fileInput.click());
    dropZone.addEventListener('dragover', e=>{ e.preventDefault(); dropZone.classList.add('hover'); });
    dropZone.addEventListener('dragleave', e=>{ e.preventDefault(); dropZone.classList.remove('hover'); });
    dropZone.addEventListener('drop', e=>{ e.preventDefault(); dropZone.classList.remove('hover'); handleFile(e.dataTransfer.files[0]); });
    fileInput.addEventListener('change', e=>handleFile(e.target.files[0]));

    function handleFile(file){
        if(!file) return;
        uploadedFile = file;

        const imgURL = URL.createObjectURL(file);
        img.onload = () => {
            imgLoaded = true;
            if(img.width<256 || img.height<256){
                selection.size = 256;
            } else {
                selection.size = Math.min(img.width, img.height, 256);
            }
            selection.x = 0;
            selection.y = 0;
            drawCanvas();
            overlay.style.display='block';
            popup.style.display='block';
        }
        img.src = imgURL;
    }

    function drawCanvas(){
        if(!imgLoaded) return;

        if(backgroundTransparent){
            ctx.clearRect(0,0,canvas.width,canvas.height);
        } else {
            ctx.fillStyle = backgroundColor;
            ctx.fillRect(0,0,canvas.width,canvas.height);
        }

        ctx.save();
        ctx.filter = `brightness(${brightnessInput.value}%) contrast(${contrastInput.value}%) saturate(${saturationInput.value}%)`;
        ctx.translate(canvas.width/2, canvas.height/2);
        ctx.rotate(rotateInput.value*Math.PI/180);
        ctx.scale(flipped?-1:1,1);
        ctx.drawImage(img, -canvas.width/2, -canvas.height/2, canvas.width, canvas.height);
        ctx.restore();

        ctx.strokeStyle = 'red';
        ctx.setLineDash([5,3]);
        ctx.strokeRect(selection.x, selection.y, selection.size, selection.size);
        ctx.setLineDash([]);
    }

    bgColorInput.addEventListener('input', drawCanvas);
    rotateInput.addEventListener('input', drawCanvas);
    flipBtn.addEventListener('click', ()=>{ flipped=!flipped; drawCanvas(); });
    brightnessInput.addEventListener('input', drawCanvas);
    contrastInput.addEventListener('input', drawCanvas);
    saturationInput.addEventListener('input', drawCanvas);
    templateBtn.addEventListener('click', ()=>{ selection={x:0,y:0,size:256}; drawCanvas(); });

    canvas.addEventListener('mousedown', startMouse);
    canvas.addEventListener('mousemove', moveMouse);
    canvas.addEventListener('mouseup', endMouse);
    canvas.addEventListener('mouseleave', endMouse);
    canvas.addEventListener('touchstart', e=>{ const t=e.touches[0]; startMouse({clientX:t.clientX, clientY:t.clientY}); e.preventDefault(); });
    canvas.addEventListener('touchmove', e=>{ const t=e.touches[0]; moveMouse({clientX:t.clientX, clientY:t.clientY}); e.preventDefault(); });
    canvas.addEventListener('touchend', e=>{ endMouse(); e.preventDefault(); });

    function startMouse(e){
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX-rect.left;
        const my = e.clientY-rect.top;
        const handles = [
            {name:'nw', x:selection.x, y:selection.y},
            {name:'ne', x:selection.x+selection.size, y:selection.y},
            {name:'sw', x:selection.x, y:selection.y+selection.size},
            {name:'se', x:selection.x+selection.size, y:selection.y+selection.size}
        ];
        currentHandle=null;
        for(let h of handles){
            if(Math.abs(mx-h.x)<=10 && Math.abs(my-h.y)<=10){ resizing=true; currentHandle=h.name; return; }
        }
        if(mx>=selection.x && mx<=selection.x+selection.size && my>=selection.y && my<=selection.y+selection.size){
            dragging=true;
            startPos={x:mx-selection.x, y:my-selection.y};
        }
    }

    function moveMouse(e){
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX-rect.left;
        const my = e.clientY-rect.top;
        if(dragging){
            selection.x=Math.max(0, Math.min(mx-startPos.x, canvas.width-selection.size));
            selection.y=Math.max(0, Math.min(my-startPos.y, canvas.height-selection.size));
            drawCanvas();
        } else if(resizing && currentHandle){
            let newX=selection.x,newY=selection.y,newSize=selection.size;
            switch(currentHandle){
                case 'se': newSize=Math.max(256,Math.min(mx-selection.x,my-selection.y)); break;
                case 'sw': newSize=Math.max(256,Math.min(selection.x+selection.size-mx,my-selection.y)); newX=selection.x+selection.size-newSize; break;
                case 'ne': newSize=Math.max(256,Math.min(mx-selection.x,selection.y+selection.size-my)); newY=selection.y+selection.size-newSize; break;
                case 'nw': newSize=Math.max(256,Math.min(selection.x+selection.size-mx,selection.y+selection.size-my)); newX=selection.x+selection.size-newSize; newY=selection.y+selection.size-newSize; break;
            }
            if(newX<0) newX=0; if(newY<0) newY=0;
            if(newX+newSize>canvas.width) newSize=canvas.width-newX;
            if(newY+newSize>canvas.height) newSize=canvas.height-newY;
            selection={x:newX,y:newY,size:newSize};
            drawCanvas();
        }
    }

    function endMouse(){ dragging=false; resizing=false; currentHandle=null; }

    function closePopup(){ overlay.style.display='none'; popup.style.display='none'; fileInput.value=''; uploadedFile=null; imgLoaded=false; }
    cancelBtn.addEventListener('click', closePopup);
    overlay.addEventListener('click', closePopup);

    confirmBtn.addEventListener('click', ()=>{
        if(!uploadedFile || !imgLoaded) return;

        const tmpCanvas=document.createElement('canvas');
        tmpCanvas.width=selection.size; tmpCanvas.height=selection.size;
        const tmpCtx=tmpCanvas.getContext('2d');

        const scaleX=img.width/canvas.width;
        const scaleY=img.height/canvas.height;

        if(backgroundTransparent){
            tmpCtx.clearRect(0,0,tmpCanvas.width,tmpCanvas.height);
        } else {
            tmpCtx.fillStyle=backgroundColor;
            tmpCtx.fillRect(0,0,tmpCanvas.width,tmpCanvas.height);
        }

        tmpCtx.save();
        tmpCtx.filter=`brightness(${brightnessInput.value}%) contrast(${contrastInput.value}%) saturate(${saturationInput.value}%)`;
        tmpCtx.translate(tmpCanvas.width/2,tmpCanvas.height/2);
        tmpCtx.rotate(rotateInput.value*Math.PI/180);
        tmpCtx.scale(flipped?-1:1,1);
        tmpCtx.drawImage(img,
            selection.x*scaleX,
            selection.y*scaleY,
            selection.size*scaleX,
            selection.size*scaleY,
            -tmpCanvas.width/2,
            -tmpCanvas.height/2,
            tmpCanvas.width,
            tmpCanvas.height
        );
        tmpCtx.restore();

        tmpCanvas.toBlob(blob=>{
            const formData=new FormData();
            formData.append('file', blob, uploadedFile.name.replace(/\..+$/,'')+'.png');
            fetch(`/admin/emoji/${uploadedFile.name}`, { method:'POST', body:formData })
                .then(res=>res.json())
                .then(data=>{ if(data?.success){ closePopup(); fetchEmojiList(); }else alert('ì—…ë¡œë“œ ì‹¤íŒ¨'); })
                .catch(err=>{ console.error(err); alert('ì—…ë¡œë“œ ì‹¤íŒ¨'); });
        }, 'image/png');
    });

    fetchEmojiList();
</script>
</body>
</html>