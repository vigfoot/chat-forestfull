<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title th:text="'Room - ' + ${room.name}">Chat Room</title>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        .chat-window { height: 60vh; overflow-y: auto; background: #fff; padding: 1rem; border-radius: 8px; }
        .message { margin-bottom: .75rem; }
        .message .meta { font-size: .8rem; color: #666; }
        .message.me { text-align: right; }
        .message.me .bubble { display: inline-block; background: #DCF8C6; padding: .5rem .75rem; border-radius: .75rem; }
        .message.other .bubble { display: inline-block; background: #F1F0F0; padding: .5rem .75rem; border-radius: .75rem; }
        .participants { max-height: 60vh; overflow-y: auto; }
    </style>

    <!-- SockJS + Stomp -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

    <!-- Optional: format time -->
    <script>
        function fmtTime(ts) {
            try {
                return new Date(ts).toLocaleString();
            } catch (e) {
                return ts;
            }
        }
    </script>
</head>
<body class="bg-light">
<div class="container py-4">
    <div class="d-flex align-items-center mb-3">
        <h4 class="me-auto">채팅방: <span th:text="${room.name}">Room</span></h4>
        <a class="btn btn-outline-secondary btn-sm" th:href="@{/chat/rooms}">방 목록</a>
    </div>

    <div class="row g-3">
        <div class="col-md-9">
            <div id="chatWindow" class="chat-window shadow-sm" aria-live="polite"></div>

            <div class="input-group mt-3">
                <input id="msgInput" type="text" class="form-control" placeholder="메시지를 입력하세요" autocomplete="off">
                <button id="sendBtn" class="btn btn-primary">전송</button>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card">
                <div class="card-header">참여자</div>
                <ul id="participants" class="list-group list-group-flush participants">
                </ul>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const ROOM_ID = /*[[${room.id}]]*/ 0;
    const ROOM_NAME = /*[[${room.name}]]*/ 'room';
    const CURRENT_USER = /*[[${currentUserName}]]*/ 'You';
</script>

<script>
    (function() {
        const roomId = ROOM_ID;
        const chatWindow = document.getElementById('chatWindow');
        const participantsEl = document.getElementById('participants');
        const msgInput = document.getElementById('msgInput');
        const sendBtn = document.getElementById('sendBtn');

        let stompClient = null;
        let connected = false;
        const accessToken = localStorage.getItem('accessToken');
        const myId = localStorage.getItem('memberId'); // JWT 디코드하여 서버가 내려주면 더 좋음

        function appendMessage(msg, opt = {}) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message ' + (opt.isMe ? 'me' : 'other');

            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            bubble.textContent = msg.message;

            const meta = document.createElement('div');
            meta.className = 'meta';
            const name = msg.senderName || msg.sender || 'unknown';
            meta.textContent = name + ' · ' + fmtTime(msg.sentAt);

            wrapper.appendChild(meta);
            wrapper.appendChild(bubble);
            chatWindow.appendChild(wrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function isMyMessage(msg) {
            return myId && msg.memberId && (String(msg.memberId) === String(myId));
        }

        function setParticipants(list) {
            participantsEl.innerHTML = '';
            list.forEach(p => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = p.displayName || ('user-' + p.memberId);
                participantsEl.appendChild(li);
            });
        }

        function loadHistory() {
            fetch(`/api/chat/rooms/${roomId}/messages?limit=100`)
                .then(res => res.json())
                .then(json => {
                    json.forEach(m => appendMessage(m, { isMe: isMyMessage(m) }));
                });
        }

        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.debug = null;

            const headers = accessToken ? { 'Authorization': 'Bearer ' + accessToken } : {};

            stompClient.connect(headers, function() {
                connected = true;

                stompClient.subscribe('/sub/chat/room/' + roomId, function(res) {
                    const msg = JSON.parse(res.body);
                    appendMessage(msg, { isMe: isMyMessage(msg) });
                });

                // 참여자 실시간 업데이트
                stompClient.subscribe('/sub/chat/room/' + roomId + '/participants', function(res) {
                    const list = JSON.parse(res.body);
                    setParticipants(list);
                });

                // 서버에서 세션 인증 후 자동 join 처리 기대
                loadHistory();
            }, function() {
                connected = false;
                setTimeout(connect, 3000);
            });
        }

        function sendMessage() {
            const text = msgInput.value && msgInput.value.trim();
            if (!text || !connected) return;
            const payload = { roomId: roomId, message: text };
            stompClient.send('/pub/chat/message', {}, JSON.stringify(payload));
            msgInput.value = '';
        }

        // UI 이벤트 등록
        sendBtn.addEventListener('click', sendMessage);
        msgInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

        loadHistory();
        connect();
    })();
</script>
</body>
</html>