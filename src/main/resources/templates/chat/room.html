<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <script th:replace="~{/layout/config.html}"></script>

    <style>
        /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ì¬ì„¤ì • */
        body {
            background-color: var(--cf-dark-bg-primary); /* Dark Theme Background */
            color: var(--cf-text-primary);
        }

        /* ë©”ì¸ ì±„íŒ… ì˜ì—­ */
        .chat-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* ì°¸ì—¬ì ëª©ë¡ ìŠ¤íƒ€ì¼ */
        .participants-sidebar {
            width: 280px; /* ë°ìŠ¤í¬í†± ë„ˆë¹„ í™•ì¥ */
            min-width: 200px;
            background-color: var(--cf-dark-bg-secondary);
            border-right: 1px solid var(--cf-border-color);
            padding: 1rem;
            box-sizing: border-box;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .participants-sidebar h4 {
            color: var(--cf-text-primary);
            border-bottom: 1px solid var(--cf-border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .participant {
            display: flex;
            align-items: center;
            padding: 0.3rem 0;
            color: var(--cf-text-primary);
        }

        .participant-name {
            font-weight: 600;
            margin-left: 10px;
        }

        /* ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ */
        #chatContainer {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: var(--cf-dark-bg-primary);
        }

        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .message {
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 70%;
            font-size: 0.95rem;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .mine {
            margin-left: auto;
            background-color: var(--cf-accent-primary); /* ForestFull Primary Color */
            color: var(--cf-dark-bg-primary); /* ì§™ì€ ë°°ê²½ì— ë°ì€ í…ìŠ¤íŠ¸ */
            border-bottom-right-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .other {
            background-color: var(--cf-dark-bg-secondary);
            color: var(--cf-text-primary);
            border: 1px solid var(--cf-border-color);
            border-bottom-left-radius: 4px;
            display: flex;
            align-items: flex-start;
            padding-left: 0; /* ì•„ë°”íƒ€ ë•Œë¬¸ì— ì•ˆìª½ íŒ¨ë”© ì œê±° */
        }

        .other .avatar-wrap {
            padding: 10px 0 10px 14px; /* ì•„ë°”íƒ€ë¥¼ í¬í•¨í•œ ì˜ì—­ íŒ¨ë”© */
        }

        .other .message-content {
            padding: 10px 14px 10px 10px; /* ë©”ì‹œì§€ í…ìŠ¤íŠ¸ ì˜ì—­ íŒ¨ë”© */
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
            /* ê¸°ë³¸ ì´ë¯¸ì§€ì˜ ê²€ì • í…Œë‘ë¦¬ë¥¼ ë³´ì¡´í•˜ê¸° ìœ„í•´ borderë¥¼ ì œê±°í•©ë‹ˆë‹¤. */
            /* border: 1px solid var(--cf-border-color); */
        }

        .other .sender-name {
            font-size: 0.8em;
            color: var(--cf-text-secondary);
            margin-bottom: 4px;
            display: block;
        }

        .system-msg {
            text-align: center;
            color: var(--cf-text-secondary);
            font-size: 0.85rem;
            margin: 1rem 0;
            font-style: italic;
        }

        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        .input-wrap {
            padding: 0.75rem 1rem;
            background-color: var(--cf-dark-bg-secondary);
            border-top: 1px solid var(--cf-border-color);
            gap: 10px;
        }

        #messageInput {
            background-color: var(--cf-dark-bg-primary);
            color: var(--cf-text-primary);
            border: 1px solid var(--cf-border-color);
        }

        #messageInput::placeholder {
            color: var(--cf-text-secondary);
        }

        #sendBtn {
            background-color: var(--cf-accent-primary);
            border-color: var(--cf-accent-primary);
            color: var(--cf-dark-bg-primary);
            font-weight: bold;
        }

        #sendBtn:hover {
            filter: brightness(1.1);
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ì¡°ì • */
        @media (max-width: 768px) {
            .participants-sidebar {
                position: fixed;
                top: 0;
                right: 0;
                bottom: 0;
                transform: translateX(100%);
                transition: transform 0.3s ease-in-out;
                z-index: 1040;
                width: 70%;
                box-shadow: -4px 0 10px rgba(0, 0, 0, 0.5);
            }

            .participants-sidebar.open {
                transform: translateX(0);
            }

            .chat-container {
                border-radius: 0;
            }
        }
    </style>

    <title>Chat ForestFull | Room #<span th:text="${roomId}"></span></title>
</head>
<body class="d-flex flex-column min-vh-100">

<div class="d-flex flex-column flex-grow-1" style="height: 100vh;">
    <div class="d-flex align-items-center justify-content-between p-3"
         style="background-color: var(--cf-dark-bg-secondary); border-bottom: 1px solid var(--cf-border-color);">

        <button class="btn btn-sm btn-secondary fw-bold" onclick="location.href='/pages/rooms'">
            <i class="bi bi-arrow-left me-1"></i> Rooms
        </button>

        <h5 class="mb-0 fw-bold text-center flex-grow-1" style="color: var(--cf-text-primary);">
            Room #<span th:text="${roomId}"></span>
        </h5>

        <button id="toggleParticipantsBtn" class="btn btn-sm btn-primary d-md-none fw-bold">
            <i class="bi bi-people-fill me-1"></i> <span id="mobile-participant-count">0</span>
        </button>
        <div class="d-none d-md-block" style="width: 70px;"></div>
    </div>

    <div class="chat-container flex-grow-1">
        <div id="chatContainer"></div>

        <div class="participants-sidebar d-none d-md-block" id="participantsSidebar">
            <h4>
                Participants
                <span class="badge text-bg-secondary fw-bold" id="desktop-participant-count">0</span>
            </h4>
            <div id="participantsList"></div>
        </div>
    </div>

    <div class="input-wrap d-flex">
        <input type="text" id="messageInput" class="form-control" placeholder="Type your message">
        <button id="sendBtn" class="btn btn-primary">Send</button>
    </div>
</div>

<div class="modal-backdrop fade" id="sidebar-backdrop" style="display: none;"></div>


<script th:inline="javascript">
    const roomId = /*[[${roomId}]]*/ 0;
    const payload = getJwtPayload('JWT_PAYLOAD');
    const MY_ID = Number(payload?.sub);
    const MY_NAME = payload?.username;
    const MY_DISPLAY_NAME = payload?.displayName || 'Me';
    const MY_PROFILE_IMAGE = payload?.profileImage;

    let reconnectInterval = 5000;
    let participants = [];

    // ğŸš© MODIFIED: ê¸°ë³¸ í”„ë¡œí•„ ì´ë¯¸ì§€ ê²½ë¡œ ìƒìˆ˜ë¡œ ì •ì˜
    const DEFAULT_AVATAR_PATH = '/images/default-avatar.png';

    // ------------------------------------------------
    // 1. WebSocket / STOMP Logic
    // ------------------------------------------------

    function connectWebSocket() {
        const socket = new SockJS("/ws/chat");
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, () => {
            console.log("WebSocket connected");

            // ë©”ì‹œì§€ êµ¬ë…
            stompClient.subscribe(`/topic/rooms/${roomId}`, msg => {
                const message = JSON.parse(msg.body);
                addMessage(message);
            });

            // ì°¸ì—¬ì ë¦¬ìŠ¤íŠ¸ êµ¬ë… (Full list update)
            stompClient.subscribe(`/topic/rooms/${roomId}/participants`, msg => {
                const users = JSON.parse(msg.body);
                updateUsers(users);
            });

            // ì±„íŒ…ë°© ì…ì¥ ë©”ì‹œì§€ ì „ì†¡
            stompClient.send("/app/chat.enter", {}, JSON.stringify({
                roomId,
                user: {
                    id: MY_ID,
                    name: MY_NAME,
                    displayName: MY_DISPLAY_NAME,
                    profileImage: MY_PROFILE_IMAGE,
                }
            }));
        }, error => {
            console.error("WebSocket connection failed:", error);
            setTimeout(connectWebSocket, reconnectInterval);
        });
    }

    function disconnectWebSocket() {
        if (stompClient && stompClient.connected) {
            // LEAVE ë©”ì‹œì§€ë¥¼ ë¨¼ì € ë³´ëƒ„
            stompClient.send("/app/chat.leave", {}, JSON.stringify({
                roomId: roomId,
                user: {
                    id: MY_ID,
                    name: MY_NAME,
                    displayName: MY_DISPLAY_NAME,
                    profileImage: MY_PROFILE_IMAGE,
                }
            }));

            stompClient.disconnect(() => {
                console.log("WebSocket disconnected");
            });
        }
        stompClient = null;
    }

    function sendMessage(text) {
        if (!text || !stompClient || !stompClient.connected) return;
        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
            roomId: roomId,
            user: {
                id: MY_ID,
                name: MY_NAME,
                displayName: MY_DISPLAY_NAME,
                profileImage: MY_PROFILE_IMAGE,
            },
            type: "TALK",
            message: text
        }));
    }

    // ------------------------------------------------
    // 2. UI Rendering Logic (ìˆ˜ì •)
    // ------------------------------------------------

    /**
     * ìµœì¢… í™•ì •ëœ ê¸°ë³¸ ì•„ë°”íƒ€ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
     * @param {string} profileImageUrl - ì‹¤ì œ í”„ë¡œí•„ ì´ë¯¸ì§€ URL
     * @returns {string} - HTML <img> íƒœê·¸ ë¬¸ìì—´
     */
    function renderAvatar(profileImageUrl) {
        const imageUrl = profileImageUrl || DEFAULT_AVATAR_PATH;

        // ğŸš© MODIFIED: ì´ì œ ë³µì¡í•œ ì•„ì´ì½˜ ë¡œì§ ëŒ€ì‹ , ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ DEFAULT_AVATAR_PATH ì‚¬ìš©
        return `<img src="${imageUrl}" alt="Avatar" class="user-avatar">`;
    }


    function addMessage(message) {
        const container = document.getElementById("chatContainer");
        const div = document.createElement("div");

        if (message.type === "ENTER" || message.type === "LEAVE") {
            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ (ì…ì¥/í‡´ì¥)
            div.textContent = `${message.user.displayName} has ${message.type === "ENTER" ? "joined" : "left"}`;
            div.classList.add("system-msg");
        } else { // TALK
            const isMine = MY_ID === message.user.id;

            div.classList.add("message");
            div.classList.add(isMine ? "mine" : "other");

            if (!isMine) {
                // ìƒëŒ€ë°© ë©”ì‹œì§€: ì•„ë°”íƒ€ + ì´ë¦„ + ë©”ì‹œì§€
                div.innerHTML = `
                    <div class="avatar-wrap">
                        ${renderAvatar(message.user.profileImage)}
                    </div>
                    <div class="message-content">
                        <span class="sender-name">${message.user.displayName || 'User'}</span>
                        <span class="text-break">${escapeHtml(message.message)}</span>
                    </div>
                `;
            } else {
                // ë‚´ ë©”ì‹œì§€: ë©”ì‹œì§€ í…ìŠ¤íŠ¸ë§Œ
                div.innerHTML = `<span class="text-break">${escapeHtml(message.message)}</span>`;
            }
        }

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function updateUsers(users) {
        const container = document.getElementById("participantsList");
        container.innerHTML = "";
        participants = users; // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸

        // ì¸ì› ìˆ˜ ë±ƒì§€ ì—…ë°ì´íŠ¸
        const count = users.length;
        document.getElementById("desktop-participant-count").textContent = count;
        document.getElementById("mobile-participant-count").textContent = count;

        users.forEach(u => {
            const isMine = MY_ID === u.user.id;
            const displayName = u.user.displayName || 'Unknown';

            const div = document.createElement("div");
            div.classList.add("participant");
            div.classList.add('d-flex');
            div.classList.add('align-items-center');

            // ğŸš© MODIFIED: renderAvatar í—¬í¼ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì•„ë°”íƒ€ ë Œë”ë§
            div.innerHTML = `
                ${renderAvatar(u.user.profileImage)}
                <span class="participant-name">${displayName}</span>
                ${isMine ? '<span class="badge text-bg-info ms-auto">Me</span>' : ''}
            `;
            container.appendChild(div);
        });
    }

    // HTML Escape Helper
    function escapeHtml(s) {
        if (!s) return '';
        return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;');
    }

    // ------------------------------------------------
    // 3. Event Handlers & Initialization
    // ------------------------------------------------

    // ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” í† ê¸€
    document.getElementById("toggleParticipantsBtn").addEventListener('click', () => {
        const sidebar = document.getElementById("participantsSidebar");
        const backdrop = document.getElementById("sidebar-backdrop");
        sidebar.classList.toggle('open');
        // 'd-md-block' í´ë˜ìŠ¤ê°€ ëª¨ë°”ì¼ì—ì„œ ìˆ¨ê¹€ì„ ë§‰ì§€ ì•Šë„ë¡ ì¡°ì¹˜
        if (window.innerWidth <= 768) {
            sidebar.classList.remove('d-md-block');
            sidebar.classList.remove('d-none');
        }
        backdrop.style.display = sidebar.classList.contains('open') ? 'block' : 'none';
    });
    // ë°°ê²½ í´ë¦­ ì‹œ ì‚¬ì´ë“œë°” ë‹«ê¸° (ëª¨ë°”ì¼)
    document.getElementById("sidebar-backdrop").addEventListener('click', () => {
        document.getElementById("participantsSidebar").classList.remove('open');
        document.getElementById("sidebar-backdrop").style.display = 'none';
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ
    document.addEventListener("DOMContentLoaded", () => {
        connectWebSocket();

        // 1. ì´ì „ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° (fetch)
        fetch(`/api/chat/rooms/${roomId}/messages`, {credentials: 'include'})
            .then(res => res.json())
            .then(messages => {
                if (messages && messages.length > 0) {
                    messages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt)).forEach(addMessage);
                } else {
                    addMessage({type: "SYSTEM", message: "Start chatting now!"});
                }
            })
            .catch(error => {
                console.error("Failed to load history:", error);
                addMessage({type: "SYSTEM", message: "Failed to load chat history."});
            });


        // 2. ë©”ì‹œì§€ ì „ì†¡ ì´ë²¤íŠ¸
        const input = document.getElementById("messageInput");
        const sendBtn = document.getElementById("sendBtn");

        const handleSend = () => {
            const text = input.value.trim();
            if (text) {
                sendMessage(text);
                input.value = "";
                input.focus();
            }
        }

        input.addEventListener("keydown", e => {
            if (e.key === "Enter") {
                e.preventDefault();
                handleSend();
            }
        });
        sendBtn.addEventListener("click", handleSend);

        // 3. í˜ì´ì§€ ì´íƒˆ ì‹œ ì²˜ë¦¬
        const handleLeave = () => {
            disconnectWebSocket();
        };

        window.addEventListener("pagehide", handleLeave);
        window.addEventListener("beforeunload", handleLeave);
    });
</script>
</body>
</html>