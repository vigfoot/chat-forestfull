<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <script th:replace="~{/layout/config.html}"></script>

    <style>
        /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ì¬ì„¤ì • */
        body {
            background-color: var(--cf-dark-bg-primary); /* Dark Theme Background */
            color: var(--cf-text-primary);
        }

        /* ë©”ì¸ ì±„íŒ… ì˜ì—­ */
        .chat-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* ì°¸ì—¬ì ëª©ë¡ ìŠ¤íƒ€ì¼ */
        .participants-sidebar {
            width: 280px; /* ë°ìŠ¤í¬í†± ë„ˆë¹„ í™•ì¥ */
            min-width: 200px;
            background-color: var(--cf-dark-bg-secondary);
            border-right: 1px solid var(--cf-border-color);
            padding: 1rem;
            box-sizing: border-box;
            overflow-y: auto;
            flex-shrink: 0;
            display: block;
        }

        .participants-sidebar h4 {
            color: var(--cf-text-primary);
            border-bottom: 1px solid var(--cf-border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .participant {
            display: flex;
            align-items: center;
            padding: 0.3rem 0;
            color: var(--cf-text-primary);
            cursor: pointer; /* í´ë¦­ ê°€ëŠ¥ í‘œì‹œ */
        }

        .participant-name {
            font-weight: 600;
            margin-left: 10px;
        }

        /* ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ */
        #chatContainer {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: var(--cf-dark-bg-primary);
        }

        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .message {
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 70%;
            font-size: 0.95rem;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .mine {
            margin-left: auto;
            background-color: var(--cf-accent-primary); /* ForestFull Primary Color */
            color: var(--cf-dark-bg-primary); /* ì§™ì€ ë°°ê²½ì— ë°ì€ í…ìŠ¤íŠ¸ */
            border-bottom-right-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .other {
            background-color: var(--cf-dark-bg-secondary);
            color: var(--cf-text-primary);
            border: 1px solid var(--cf-border-color);
            border-bottom-left-radius: 4px;
            display: flex;
            align-items: flex-start;
            padding-left: 0; /* ì•„ë°”íƒ€ ë•Œë¬¸ì— ì•ˆìª½ íŒ¨ë”© ì œê±° */
        }

        .other .avatar-wrap {
            padding: 10px 0 10px 14px; /* ì•„ë°”íƒ€ë¥¼ í¬í•¨í•œ ì˜ì—­ íŒ¨ë”© */
        }

        .other .message-content {
            padding: 10px 14px 10px 10px; /* ë©”ì‹œì§€ í…ìŠ¤íŠ¸ ì˜ì—­ íŒ¨ë”© */
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
            cursor: pointer; /* í´ë¦­ ê°€ëŠ¥ í‘œì‹œ */
        }

        .other .sender-name {
            font-size: 0.8em;
            color: var(--cf-text-secondary);
            margin-bottom: 4px;
            display: block;
        }

        .system-msg {
            text-align: center;
            color: var(--cf-text-secondary);
            font-size: 0.85rem;
            margin: 1rem 0;
            font-style: italic;
        }

        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        .input-wrap {
            padding: 0.75rem 1rem;
            background-color: var(--cf-dark-bg-secondary);
            border-top: 1px solid var(--cf-border-color);
            gap: 10px;
        }

        /* ğŸš© íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .input-wrap .btn-icon {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            padding: 0;
            font-size: 1.25rem;
            background-color: transparent;
            color: var(--cf-text-secondary);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-wrap .btn-icon:hover {
            color: var(--cf-accent-primary);
        }

        /* ğŸš© ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ë‚´ ì½˜í…ì¸  ìŠ¤íƒ€ì¼ */
        .preview-content {
            height: 400px;
            border: 1px solid var(--cf-border-color);
            background-color: var(--cf-dark-bg-primary);
            overflow: hidden;
        }

        .preview-content img,
        .preview-content video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        #messageInput {
            background-color: var(--cf-dark-bg-primary);
            color: var(--cf-text-primary);
            border: 1px solid var(--cf-border-color);
        }

        #messageInput::placeholder {
            color: var(--cf-text-secondary);
        }

        #sendBtn {
            flex-shrink: 0;
            background-color: var(--cf-accent-primary);
            border-color: var(--cf-accent-primary);
            color: var(--cf-dark-bg-primary);
            font-weight: bold;
        }

        #sendBtn:hover {
            filter: brightness(1.1);
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ì¡°ì • */
        @media (max-width: 1200px) {
            .participants-sidebar {
                position: fixed;
                top: 0;
                right: 0;
                bottom: 0;
                transform: translateX(100%);
                transition: transform 0.3s ease-in-out;
                z-index: 1040;
                box-shadow: -4px 0 10px rgba(0, 0, 0, 0.5);
            }

            .participants-sidebar.open {
                transform: translateX(0);
            }

            .chat-container {
                border-radius: 0;
            }
        }

        /* ë°ìŠ¤í¬í†± í¬ê¸°ì—ì„œ ì‚¬ì´ë“œë°”ê°€ í•­ìƒ ë³´ì´ë„ë¡ ì„¤ì • */
        @media (min-width: 1201px) {
            .participants-sidebar {
                transform: translateX(0) !important;
                position: relative;
            }
        }
    </style>

    <title th:text="${'Chat ForestFull - ' + room.name}"></title>
</head>
<body class="d-flex flex-column min-vh-100" style="height: 100vh;">
<div class="d-flex flex-column flex-grow-1">
    <div class="d-flex align-items-center justify-content-between p-3"
         style="background-color: var(--cf-dark-bg-secondary); border-bottom: 1px solid var(--cf-border-color);">

        <button class="btn btn-sm btn-secondary fw-bold" onclick="history.back();">
            <i class="bi bi-arrow-left me-1"></i> Rooms
        </button>

        <h5 class="mb-0 fw-bold text-center flex-grow-1" style="color: var(--cf-text-primary);">
            <span th:text="${room.name}"></span>
            <span style="font-size: 1rem; color: gray;" th:text="${'(created by ' + room.maker + ')'}"></span>
        </h5>

        <button id="toggleParticipantsBtn" class="btn btn-sm btn-primary d-xl-none fw-bold">
            <i class="bi bi-people-fill me-1"></i> <span id="mobile-participant-count">0</span>
        </button>
        <div class="d-none d-xl-block" style="width: 70px;"></div>
    </div>

    <div class="chat-container flex-grow-1">
        <div id="chatContainer"></div>

        <div class="participants-sidebar" id="participantsSidebar">
            <h4>
                Participants
                <span class="badge text-bg-secondary fw-bold" id="desktop-participant-count">0</span>
            </h4>
            <div id="participantsList"></div>
        </div>
    </div>

    <div class="input-wrap d-flex align-items-center">
        <div sec:authorize="hasRole('ROLE_ADMIN')">
            <input type="file" id="fileInput" style="display: none;" accept="image/*,video/*">
            <button id="attachFileBtn" class="btn btn-icon" title="Attach Photo">
                <i class="bi bi-image"></i>
            </button>
        </div>

        <button id="emojiBtn" class="btn btn-icon" title="Insert Emoji">
            <i class="bi bi-emoji-smile"></i>
        </button>

        <input type="text" id="messageInput" class="form-control flex-grow-1" placeholder="Type your message">

        <button id="sendBtn" class="btn btn-primary">Send</button>
    </div>
</div>

<div class="modal-backdrop fade" id="sidebar-backdrop" style="display: none;"></div>

<div class="modal fade" id="userInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: var(--cf-dark-bg-secondary); color: var(--cf-text-primary);">
            <div class="modal-header" style="border-color: var(--cf-border-color);">
                <h5 class="modal-title fw-bold">User Information</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modal-profile-image" src="/images/default-avatar.png" alt="Profile" class="rounded-circle mb-3"
                     style="width: 100px; height: 100px; border: 3px solid var(--cf-accent-primary);">
                <h4 id="modal-display-name" class="fw-bold mb-1"></h4>
                <p id="modal-username" class="text-muted small mb-3"></p>
                <div id="modal-user-info">
                </div>
            </div>
            <div class="modal-footer" style="border-color: var(--cf-border-color);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{/layout/footer.html}"></footer>
<script th:inline="javascript">
    // ì „ì—­ í•¨ìˆ˜/ë³€ìˆ˜ (connectWebSocket, get, getJwtPayload, showModal ë“±)ëŠ” config.htmlì—ì„œ ì œê³µë¨ì„ ê°€ì •

    const roomId = /*[[${roomId}]]*/ 0;
    const payload = getJwtPayload();

    // ì„œë²„ì˜ DTO í•„ë“œì— ë§ê²Œ ë³€ìˆ˜ëª… ì •ì˜
    const MY_USER_ID = Number(payload?.sub); // ChatDTO.Participant.userId
    const MY_USERNAME = payload?.username;
    const MY_DISPLAY_NAME = payload?.displayName || 'Me';
    const MY_PROFILE_IMAGE = payload?.profileImage;

    let reconnectInterval = 5000;
    let participants = []; // í˜„ì¬ ì°¸ì—¬ì ëª©ë¡ì„ ì €ì¥í•˜ëŠ” ë°°ì—´
    let isFileBeingSent = false; // ğŸš© íŒŒì¼ ì „ì†¡ ì¤‘ì¸ì§€ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸ (showModal ì·¨ì†Œ ë¡œì§ì—ì„œ ì¤‘ìš”)

    const DEFAULT_AVATAR_PATH = '/images/default-avatar.png';
    const MAX_FILE_SIZE_BYTES = 10 * 1024 * 1024; // ğŸš© ìµœëŒ€ ìš©ëŸ‰ 10MB (ìµœì¢… ì„¤ì •)
    let userInfoModal = null;
    if (typeof bootstrap !== 'undefined' && document.getElementById('userInfoModal')) {
        userInfoModal = new bootstrap.Modal(document.getElementById('userInfoModal'));
    }



    // ------------------------------------------------
    // 1. WebSocket / STOMP Logic
    // ------------------------------------------------

    function subscribeAndSendEnter() {
        // ë©”ì‹œì§€ êµ¬ë…
        stompClient.subscribe(`/topic/rooms/${roomId}`, msg => {
            const message = JSON.parse(msg.body);
            addMessage(message);
        });

        // ChatDTO.Participant ëª©ë¡ ìˆ˜ì‹ 
        stompClient.subscribe(`/topic/rooms/${roomId}/participants`, msg => {
            const users = JSON.parse(msg.body);
            updateUsers(users);
        });

        // ğŸŸ¢ ì…ì¥ ë©”ì‹œì§€ ì „ì†¡: ChatDTO.Participant êµ¬ì¡°ë¡œ í‰íƒ„í™”í•˜ì—¬ ì „ì†¡ (ì„œë²„ ì»¨íŠ¸ë¡¤ëŸ¬ ê¸°ëŒ€ í¬ë§·)
        stompClient.send("/app/chat.enter", {}, JSON.stringify({
            roomId: roomId,
            userId: MY_USER_ID, // ğŸš© MY_ID ëŒ€ì‹  userId í•„ë“œ ì‚¬ìš©
            username: MY_USERNAME,
            displayName: MY_DISPLAY_NAME,
            profileImage: MY_PROFILE_IMAGE,
        }));
    }

    function disconnectWebSocket() {
        if (stompClient && stompClient.connected) {
            // ğŸŸ¢ í‡´ì¥ ë©”ì‹œì§€ ì „ì†¡: ChatDTO.Participant êµ¬ì¡°ë¡œ í‰íƒ„í™”í•˜ì—¬ ì „ì†¡ (ì„œë²„ ì»¨íŠ¸ë¡¤ëŸ¬ ê¸°ëŒ€ í¬ë§·)
            stompClient.send("/app/chat.leave", {}, JSON.stringify({
                roomId: roomId,
                userId: MY_USER_ID, // ğŸš© MY_ID ëŒ€ì‹  userId í•„ë“œ ì‚¬ìš©
                username: MY_USERNAME,
                displayName: MY_DISPLAY_NAME,
                profileImage: MY_PROFILE_IMAGE,
            }));

            stompClient.disconnect(() => {
                console.log("WebSocket disconnected");
            });
        }
        stompClient = null;
    }

    function sendMessage(text) {
        if (!text || !stompClient || !stompClient.connected) return;
        // ğŸŸ¢ TALK ë©”ì‹œì§€ ì „ì†¡: ChatDTO.Message êµ¬ì¡° (user ê°ì²´ í¬í•¨) ìœ ì§€
        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
            roomId: roomId,
            user: {
                id: MY_USER_ID, // ğŸš© TALK ë©”ì‹œì§€ ë‚´ë¶€ User DTOëŠ” id í•„ë“œ ì‚¬ìš©
                name: MY_USERNAME, // ğŸš© ì„œë²„ DTOë¥¼ ìœ„í•´ nameì„ ì‚¬ìš©í•¨ (ì´ ë¶€ë¶„ì—ì„œ DTO ë¶ˆì¼ì¹˜ ì´ìŠˆ ë°œìƒ ê°€ëŠ¥ì„± ìˆìŒ)
                displayName: MY_DISPLAY_NAME,
                profileImage: MY_PROFILE_IMAGE,
            },
            type: "TALK",
            message: text
        }));
    }

    // ------------------------------------------------
    // 2. UI Rendering Logic
    // ------------------------------------------------

    function renderAvatar(profileImageUrl) {
        const imageUrl = profileImageUrl && profileImageUrl !== 'null' ? profileImageUrl : DEFAULT_AVATAR_PATH;
        return imageUrl;
    }

    // ğŸŸ¢ í—¬í¼ í•¨ìˆ˜: ChatDTO.Message ë‚´ë¶€ User DTO (id, username, displayName, profileImage í¬í•¨)
    function getUserInfoString(user) {
        if (!user) return '{}';
        return JSON.stringify({
            id: user.id,
            username: user.username,
            displayName: user.displayName,
            profileImage: user.profileImage,
        }).replaceAll('"', '&quot;');
    }

    // ğŸŸ¢ í—¬í¼ í•¨ìˆ˜: ChatDTO.Participant DTO (userId, username, displayName, profileImage í¬í•¨)
    function getParticipantInfoString(p) {
        if (!p) return '{}';
        return JSON.stringify({
            id: p.userId, // ëª¨ë‹¬ì—ì„œ idë¥¼ ê¸°ëŒ€í•˜ë¯€ë¡œ userIdë¥¼ idë¡œ ë§¤í•‘
            username: p.username,
            displayName: p.displayName,
            profileImage: p.profileImage,
        }).replaceAll('"', '&quot;');
    }


    function addMessage(message) {
        const container = document.getElementById("chatContainer");
        const div = document.createElement("div");
        const user = message.user;

        if (message.type === "ENTER" || message.type === "LEAVE") {
            const userName = user?.displayName || 'A user';
            div.textContent = `${userName} has ${message.type === "ENTER" ? "joined" : "left"}`;
            div.classList.add("system-msg");
        } else { // TALK
            const isMine = MY_USER_ID === user?.id;

            div.classList.add("message");
            div.classList.add(isMine ? "mine" : "other");

            const userInfoStr = getUserInfoString(user);

            if (!isMine) {
                const userName = user?.displayName || 'User';
                const avatarUrl = renderAvatar(user?.profileImage);

                div.innerHTML = `
                    <div class="avatar-wrap">
                        <img src="${avatarUrl}"
                             onclick="showUserInfoModal(JSON.parse(unescapeHtml('${userInfoStr}')))"
                             alt="Avatar" class="user-avatar">
                    </div>
                    <div class="message-content">
                        <span class="sender-name">${userName}</span>
                        <span class="text-break">${escapeHtml(message.message)}</span>
                    </div>
                `;
            } else {
                div.innerHTML = `<span class="text-break">${escapeHtml(message.message)}</span>`;
            }
        }

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    /**
     * ì°¸ì—¬ì ëª©ë¡ ì—…ë°ì´íŠ¸ (ChatDTO.Participant[] êµ¬ì¡°ë¥¼ ê°€ì •)
     */
    function updateUsers(users) {
        const container = document.getElementById("participantsList");
        container.innerHTML = "";
        participants = users; // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸

        const count = users.length;
        document.getElementById("desktop-participant-count").textContent = count;
        document.getElementById("mobile-participant-count").textContent = count;

        users.forEach(u => {
            const isMine = MY_USERNAME === u.username;
            const displayName = u.displayName || u.username || 'Unknown';
            const participantInfo = getParticipantInfoString(u);

            const div = document.createElement("div");
            div.classList.add("participant");

            // ğŸš© ë¦¬ìŠ¤íŠ¸ í•­ëª© í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°, ì´ë²¤íŠ¸ ì „íŒŒ ì°¨ë‹¨ ì¶”ê°€
            div.onclick = (event) => {
                event.stopPropagation();
                showUserInfoModal(JSON.parse(unescapeHtml(participantInfo)));
            };

            const avatarUrl = renderAvatar(u.profileImage);

            div.innerHTML = `
                <img src="${avatarUrl}" alt="Avatar" class="user-avatar" style="cursor: default;">
                <span class="participant-name">${displayName}</span>
                ${isMine ? '<span class="badge text-bg-info ms-auto">Me</span>' : ''}
            `;
            container.appendChild(div);
        });
    }

    // ------------------------------------------------
    // 3. User Info Modal Logic
    // ------------------------------------------------

    /**
     * ì‚¬ìš©ì ì •ë³´ë¥¼ ëª¨ë‹¬ì— í‘œì‹œí•˜ê³  ë„ì›ë‹ˆë‹¤.
     * @param {Object} userData - í‘œì‹œí•  ì‚¬ìš©ì ë°ì´í„° (id, username, displayName, profileImage í¬í•¨)
     */
    function showUserInfoModal(userData) {
        if (!userData || !userInfoModal) {
            console.error("Modal or User Data missing.", userData);
            return;
        }

        const avatarUrl = renderAvatar(userData.profileImage);

        // ëª¨ë‹¬ í•„ë“œ ì—…ë°ì´íŠ¸
        document.getElementById('modal-profile-image').src = avatarUrl;
        document.getElementById('modal-display-name').textContent = userData.displayName || 'N/A';
        document.getElementById('modal-username').textContent = `@${userData.username || 'Unknown'}`;

        // ì¶”ê°€ ì •ë³´ í•„ë“œ êµ¬ì„±
        const infoDiv = document.getElementById('modal-user-info');
        infoDiv.innerHTML = `
            ${userData.id ? `<p class="small mb-0">Member ID: ${userData.id}</p>` : ''}
        `;

        userInfoModal.show();
    }


    // HTML Escape Helper
    function escapeHtml(s) {
        if (!s) return '';
        return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;');
    }

    // HTML Unescape Helper (JSON.parseë¥¼ ìœ„í•´ í•„ìš”)
    function unescapeHtml(s) {
        if (!s) return '';
        return s.replaceAll('&quot;', '"').replaceAll('&#039;', "'").replaceAll('&lt;', '<').replaceAll('&gt;', '>').replaceAll('&amp;', '&');
    }

    // ------------------------------------------------
    // 4. File Upload Logic (showModal ì‚¬ìš©) ğŸš© íŒŒì¼ ì—…ë¡œë“œ ë¡œì§ ì‹œì‘
    // ------------------------------------------------

    /**
     * ìˆ¨ê²¨ì§„ íŒŒì¼ ì¸í’‹ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. (ì·¨ì†Œ ì•¡ì…˜)
     */
    function resetFileInput() {
        const fileInput = document.getElementById("fileInput");
        fileInput.value = ''; // íŒŒì¼ ì„ íƒ ì·¨ì†Œ
        isFileBeingSent = false;
    }

    /**
     * íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬ (íƒ€ì… ë° ìš©ëŸ‰)
     */
    function validateFile(file) {
        if (!file) {
            return "No file selected.";
        }

        const mimeType = file.type;
        if (!mimeType.startsWith('image/') && !mimeType.startsWith('video/')) {
            return "Only images and videos are allowed (image/* or video/*).";
        }

        if (file.size > MAX_FILE_SIZE_BYTES) {
            const maxMb = (MAX_FILE_SIZE_BYTES / 1024 / 1024).toFixed(1);
            const fileMb = (file.size / 1024 / 1024).toFixed(2);
            return `File size (${fileMb}MB) exceeds the maximum limit (${maxMb}MB).`;
        }

        return null;
    }

    /**
     * íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° HTML ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
     */
    function renderPreviewHtml(file) {
        const fileUrl = URL.createObjectURL(file);
        let mediaHtml = '';

        if (file.type.startsWith('image/')) {
            mediaHtml = `<img src="${fileUrl}" alt="Preview" class="d-block w-100 h-100">`;
        } else if (file.type.startsWith('video/')) {
            mediaHtml = `<video src="${fileUrl}" controls autoplay muted class="d-block w-100 h-100"></video>`;
        } else {
            mediaHtml = `<span class="text-danger">Unsupported file type for preview.</span>`;
        }

        const bodyHtml = `
            <p id="fileNameDisplay" class="mb-2 text-muted small">${file.name}</p>
            <div id="previewContent" class="d-flex justify-content-center align-items-center preview-content">
                ${mediaHtml}
            </div>
            <textarea id="fileCaption" class="form-control mt-3" placeholder="Add a caption (optional)" rows="2"
                      style="background-color: var(--cf-dark-bg-primary); color: var(--cf-text-primary); border-color: var(--cf-border-color);"></textarea>

            <p class="mt-2 small text-warning">Note: The file will be sent once you click 'Confirm'.</p>
        `;
        return bodyHtml;
    }

    /**
     * íŒŒì¼ ì „ì†¡ ë¡œì§ (showModalì˜ Confirm ì•¡ì…˜)
     */
    async function sendFileAction() {
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];

        // ìº¡ì…˜ í•„ë“œ ê°€ì ¸ì˜¤ê¸°
        const caption = document.getElementById('fileCaption')?.value || '';

        if (!file || !stompClient || !stompClient.connected) {
            showAlert("File or connection missing. Cannot send file.", 'danger');
            resetFileInput();
            return;
        }

        isFileBeingSent = true; // ì „ì†¡ ì‹œì‘ í”Œë˜ê·¸ ì„¤ì •
        showAlert(`Uploading ${file.name}...`, 'info');

        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('roomId', roomId);
            formData.append('caption', caption);

            // httpFileRequestëŠ” ì „ì—­ script.jsì— ì •ì˜ë˜ì–´ ìˆë‹¤ê³  ê°€ì •
            const response = await httpFileRequest(`/api/chat/rooms/${roomId}/files`, formData);

            if (response.ok) {
                // ì„œë²„ì—ì„œ íŒŒì¼ ì €ì¥ í›„, WebSocketìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë¸Œë¡œë“œìºìŠ¤íŠ¸í•  ê²ƒìœ¼ë¡œ ì˜ˆìƒë¨
                showAlert(`File ${file.name} sent successfully.`, 'success');
            } else {
                const errorText = await response.text();
                showAlert(`File upload failed: ${response.status} - ${errorText}`, 'danger');
            }

        } catch (error) {
            console.error("File upload network error:", error);
            showAlert("Network error during file upload.", 'danger');
        } finally {
            // ì „ì†¡ ì™„ë£Œ í›„ ìµœì¢… ì •ë¦¬
            resetFileInput();
        }
    }

    // ------------------------------------------------
    // 5. Event Handlers & Initialization
    // ------------------------------------------------

    document.getElementById("toggleParticipantsBtn").addEventListener('click', () => {
        const sidebar = document.getElementById("participantsSidebar");
        const backdrop = document.getElementById("sidebar-backdrop");

        const isOpen = sidebar.classList.toggle('open');

        if (window.innerWidth <= 1200) {
            backdrop.style.display = isOpen ? 'block' : 'none';
        }
    });

    document.getElementById("sidebar-backdrop").addEventListener('click', () => {
        document.getElementById("participantsSidebar").classList.remove('open');
        document.getElementById("sidebar-backdrop").style.display = 'none';
    });

    window.addEventListener('resize', () => {
        const sidebar = document.getElementById("participantsSidebar");
        const backdrop = document.getElementById("sidebar-backdrop");
        if (window.innerWidth > 1200) {
            sidebar.classList.remove('open');
            backdrop.style.display = 'none';
        }
    });

    document.addEventListener("DOMContentLoaded", () => {
        // 1. WebSocket ì—°ê²° ë° êµ¬ë…/ì…ì¥ ë©”ì‹œì§€ ì „ì†¡
        connectWebSocket(subscribeAndSendEnter);

        // 2. ì´ì „ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
        get(`/api/chat/rooms/${roomId}/messages`)
            .then(res => res.json())
            .then(messages => {
                if (messages && messages.length > 0) {
                    messages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt)).forEach(addMessage);
                } else {
                    addMessage({type: "SYSTEM", message: "Start chatting now!"});
                }
            })
            .catch(error => {
                console.error("Failed to load history:", error);
                addMessage({type: "SYSTEM", message: "Failed to load chat history."});
            });


        // 3. ë©”ì‹œì§€ ì „ì†¡ ì´ë²¤íŠ¸
        const input = document.getElementById("messageInput");
        const sendBtn = document.getElementById("sendBtn");

        const handleSend = () => {
            const text = input.value.trim();
            if (text) {
                sendMessage(text);
                input.value = "";
                input.focus();
            }
        }

        input.addEventListener("keydown", e => {
            if (e.key === "Enter") {
                e.preventDefault();
                handleSend();
            }
        });
        sendBtn.addEventListener("click", handleSend);

        // 4. íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        const fileInput = document.getElementById("fileInput");
        const commonModalElement = document.getElementById('commonModal'); // ì „ì—­ ëª¨ë‹¬ ìš”ì†Œ

        document.getElementById("attachFileBtn")?.addEventListener("click", () => {
            // ë²„íŠ¼ í´ë¦­ ì‹œ ìˆ¨ê²¨ì§„ íŒŒì¼ ì¸í’‹ì„ íŠ¸ë¦¬ê±°
            fileInput.click();
        });

        // ğŸš© íŒŒì¼ ì„ íƒ ì‹œ ì´ë²¤íŠ¸
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const error = validateFile(file);

            if (error) {
                showAlert(error, 'warning');
                resetFileInput();
                return;
            }

            const bodyHtml = renderPreviewHtml(file);

            // ğŸš© showModal ì „ì—­ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ í‘œì‹œ
            showModal(
                "File Preview: " + file.name,
                bodyHtml,
                sendFileAction, // Confirm ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰í•  ì•¡ì…˜
                { isStatic: true, showClose: true } // isStatic ëª¨ë“œ, ì·¨ì†Œ ë²„íŠ¼ í‘œì‹œ
            );
        });

        document.getElementById("emojiBtn").addEventListener("click", () => {
            console.log("Emoji button clicked. Implement emoji picker logic here.");
        });

        // ğŸš© ì „ì—­ ëª¨ë‹¬ì´ ë‹«í ë•Œ (ì·¨ì†Œ ë™ì‘ ì‹œ) íŒŒì¼ ì¸í’‹ ì´ˆê¸°í™”
        commonModalElement?.addEventListener('hidden.bs.modal', function (event) {
            if (!isFileBeingSent) {
                resetFileInput();
            }
        });

        // 5. í˜ì´ì§€ ì´íƒˆ ì‹œ ì²˜ë¦¬
        const handleLeave = () => {
            disconnectWebSocket();
        };

        window.addEventListener("pagehide", handleLeave);
        window.addEventListener("beforeunload", handleLeave);
    });
</script>
</body>
</html>