<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <script th:replace="~{/layout/config.html}"></script>

    <style>
        /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ì¬ì„¤ì • */
        body {
            background-color: var(--cf-dark-bg-primary); /* Dark Theme Background */
            color: var(--cf-text-primary);
        }

        /* ë©”ì¸ ì±„íŒ… ì˜ì—­ */
        .chat-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* ì°¸ì—¬ì ëª©ë¡ ìŠ¤íƒ€ì¼ */
        .participants-sidebar {
            width: 280px; /* ë°ìŠ¤í¬í†± ë„ˆë¹„ í™•ì¥ */
            min-width: 200px;
            background-color: var(--cf-dark-bg-secondary);
            border-right: 1px solid var(--cf-border-color);
            padding: 1rem;
            box-sizing: border-box;
            overflow-y: auto;
            flex-shrink: 0;
            display: block;
        }

        .participants-sidebar h4 {
            color: var(--cf-text-primary);
            border-bottom: 1px solid var(--cf-border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .participant {
            display: flex;
            align-items: center;
            padding: 0.3rem 0;
            color: var(--cf-text-primary);
            cursor: pointer; /* í´ë¦­ ê°€ëŠ¥ í‘œì‹œ */
        }

        .participant-name {
            font-weight: 600;
            margin-left: 10px;
        }

        /* ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ */
        #chatContainer {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: var(--cf-dark-bg-primary);
        }

        /* ğŸš© ë©”ì‹œì§€ ë˜í¼ ìŠ¤íƒ€ì¼ (ì‹œê°„ê³¼ ë©”ì‹œì§€ë¥¼ flexë¡œ ë¬¶ì–´ ì •ë ¬) */
        .message-wrap {
            /* ë©”ì‹œì§€ ë˜í¼ëŠ” message í´ë˜ìŠ¤ë¥¼ ëŒ€ì²´í•˜ë©°, ì‹œê°„ê³¼ ë©”ì‹œì§€ ë³¸ì²´ë¥¼ ë‹´ìŠµë‹ˆë‹¤. */
            max-width: 100%; /* ì „ì²´ ë„ˆë¹„ë¥¼ ì‚¬ìš© */
        }

        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ (ë©”ì‹œì§€ ë³¸ì²´) */
        .message {
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 70%;
            font-size: 0.95rem;
            word-wrap: break-word;
            line-height: 1.4;
        }

        /* ğŸš© ë©”ì‹œì§€ ì‹œê°„ ìŠ¤íƒ€ì¼ */
        .message-time {
            font-size: 0.75rem !important; /* ê¸€ì”¨ í¬ê¸° ë” ì‘ê²Œ */
            white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
            opacity: 0.7; /* ì•½ê°„ íë¦¬ê²Œ */
        }

        .mine {
            margin-left: auto;
            background-color: var(--cf-accent-primary); /* ForestFull Primary Color */
            color: var(--cf-dark-bg-primary); /* ì§™ì€ ë°°ê²½ì— ë°ì€ í…ìŠ¤íŠ¸ */
            border-bottom-right-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .other {
            background-color: var(--cf-dark-bg-secondary);
            color: var(--cf-text-primary);
            border: 1px solid var(--cf-border-color);
            border-bottom-left-radius: 4px;
            display: flex;
            align-items: flex-start;
            padding-left: 0; /* ì•„ë°”íƒ€ ë•Œë¬¸ì— ì•ˆìª½ íŒ¨ë”© ì œê±° */
        }

        .other .avatar-wrap {
            padding: 10px 0 10px 14px; /* ì•„ë°”íƒ€ë¥¼ í¬í•¨í•œ ì˜ì—­ íŒ¨ë”© */
        }

        .other .message-content {
            padding: 10px 14px 10px 10px; /* ë©”ì‹œì§€ í…ìŠ¤íŠ¸ ì˜ì—­ íŒ¨ë”© */
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
            cursor: pointer; /* í´ë¦­ ê°€ëŠ¥ í‘œì‹œ */
        }

        .other .sender-name {
            font-size: 0.8em;
            color: var(--cf-text-secondary);
            margin-bottom: 4px;
            display: block;
        }

        .system-msg {
            text-align: center;
            color: var(--cf-text-secondary);
            font-size: 0.85rem;
            margin: 1rem 0;
            font-style: italic;
        }

        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        .input-wrap {
            padding: 0.75rem 1rem;
            background-color: var(--cf-dark-bg-secondary);
            border-top: 1px solid var(--cf-border-color);
            gap: 10px;
        }

        /* íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .input-wrap .btn-icon {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            padding: 0;
            font-size: 1.25rem;
            background-color: transparent;
            color: var(--cf-text-secondary);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-wrap .btn-icon:hover {
            color: var(--cf-accent-primary);
        }

        /* ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ë‚´ ì½˜í…ì¸  ìŠ¤íƒ€ì¼ */
        .preview-content {
            height: 400px;
            border: 1px solid var(--cf-border-color);
            background-color: var(--cf-dark-bg-primary);
            overflow: hidden;
        }

        .preview-content img,
        .preview-content video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* ì‚¬ìš©ì ì •ë³´ ëª¨ë‹¬ì„ ìœ„í•œ ì•„ë°”íƒ€ ìŠ¤íƒ€ì¼ (commonModalBodyì— ì§ì ‘ ì ìš©) */
        .user-modal-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid var(--cf-accent-primary);
        }

        #messageInput {
            background-color: var(--cf-dark-bg-primary);
            color: var(--cf-text-primary);
            border: 1px solid var(--cf-border-color);
        }

        #messageInput::placeholder {
            color: var(--cf-text-secondary);
        }

        #sendBtn {
            flex-shrink: 0;
            background-color: var(--cf-accent-primary);
            border-color: var(--cf-accent-primary);
            color: var(--cf-dark-bg-primary);
            font-weight: bold;
        }

        #sendBtn:hover {
            filter: brightness(1.1);
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ì¡°ì • */
        @media (max-width: 1200px) {
            .participants-sidebar {
                position: fixed;
                top: 0;
                right: 0;
                bottom: 0;
                transform: translateX(100%);
                transition: transform 0.3s ease-in-out;
                z-index: 1051;
                max-width: 70%;
                box-shadow: -4px 0 10px rgba(0, 0, 0, 0.5);
            }

            .participants-sidebar.open {
                transform: translateX(0);
            }

            .chat-container {
                border-radius: 0;
            }
        }

        /* ë°ìŠ¤í¬í†± í¬ê¸°ì—ì„œ ì‚¬ì´ë“œë°”ê°€ í•­ìƒ ë³´ì´ë„ë¡ ì„¤ì • */
        @media (min-width: 1201px) {
            .participants-sidebar {
                transform: translateX(0) !important;
                position: relative;
            }
        }

        /* ------------------------------------
   [ì¶”ê°€] Emoji Picker Panel Style
   ------------------------------------ */
        .emoji-picker-panel {
            position: absolute;
            bottom: 65px; /* í—¤ë” ë†’ì´ì— ë§ê²Œ ì¡°ì • (ëŒ€ëµ) */
            left: 0;
            right: 0;
            height: 125px; /* ğŸš© ìš”êµ¬ì‚¬í•­ ë†’ì´ */
            background-color: rgba(30, 30, 30, 0.5); /* ë°˜íˆ¬ëª… ë‹¤í¬ ë°°ê²½ */
            backdrop-filter: blur(5px); /* ë°°ê²½ ë¸”ëŸ¬ íš¨ê³¼ (ì„ íƒì ) */
            border-bottom: 1px solid var(--cf-border-color);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            z-index: 999; /* ì±„íŒ… ë‚´ìš© ìœ„ì— ì˜¤ë„ë¡ ì„¤ì • */
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
            transition: transform 0.3s ease-in-out;
        }

        .emoji-list-container {
            display: flex;
            overflow-x: auto; /* ğŸš© ìˆ˜í‰ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
            overflow-y: hidden;
            gap: 10px;
            height: 70px; /* ê²€ìƒ‰ì°½ ë†’ì´ë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ê³µê°„ */
        }

        /* ê°œë³„ ì´ëª¨ì§€ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .emoji-item-chat {
            flex-shrink: 0; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            background-color: var(--cf-dark-bg-tertiary);
            cursor: pointer;
            transition: background-color 0.1s;
            user-select: none;
        }

        .emoji-item-chat:hover {
            background-color: var(--cf-accent-primary);
        }

        .emoji-item-chat img {
            max-width: 80%;
            max-height: 80%;
        }
    </style>

    <title th:text="${'Chat ForestFull - ' + room.name}"></title>
</head>
<body class="d-flex flex-column min-vh-100">
<div class="d-flex flex-column flex-grow-1" style="height: 100vh;">
    <div class="d-flex align-items-center justify-content-between p-3"
         style="background-color: var(--cf-dark-bg-secondary); border-bottom: 1px solid var(--cf-border-color);">

        <button class="btn btn-sm btn-secondary fw-bold" onclick="history.back();">
            <i class="bi bi-arrow-left me-1"></i> Rooms
        </button>

        <h5 class="mb-0 fw-bold text-center flex-grow-1" style="color: var(--cf-text-primary);">
            <span th:text="${room.name}"></span>
            <span style="font-size: 1rem; color: gray;" th:text="${'(created by ' + room.maker + ')'}"></span>
        </h5>

        <button id="toggleParticipantsBtn" class="btn btn-sm btn-primary d-xl-none fw-bold">
            <i class="bi bi-people-fill me-1"></i> <span id="mobile-participant-count">0</span>
        </button>
        <div class="d-none d-xl-block" style="width: 70px;"></div>
    </div>

    <div id="emojiPicker" class="emoji-picker-panel">
        <div class="container-fluid h-100 p-2">
            <input type="text" id="emojiSearchInput" class="form-control mb-2" placeholder="Search emoji name..."
                   style="background-color: var(--cf-dark-bg-primary); border-color: var(--cf-border-color); color: var(--cf-text-primary);">

            <div id="emojiListContainer" class="emoji-list-container">
                <p class="text-center text-secondary w-100 mt-3 small">Loading or no emojis found.</p>
            </div>
        </div>
    </div>

    <div class="chat-container flex-grow-1">
        <div id="chatContainer"></div>

        <div class="participants-sidebar" id="participantsSidebar">
            <h4>
                Participants
                <span class="badge text-bg-secondary fw-bold" id="desktop-participant-count">0</span>
            </h4>
            <div id="participantsList"></div>
        </div>
    </div>

    <div class="input-wrap d-flex align-items-center">
        <div sec:authorize="hasRole('ROLE_ADMIN')">
            <input type="file" id="fileInput" style="display: none;" accept="image/*,video/*">
            <button id="attachFileBtn" class="btn btn-icon" title="Attach Photo">
                <i class="bi bi-image"></i>
            </button>
        </div>

        <button id="emojiBtn" class="btn btn-icon" title="Insert Emoji">
            <i class="bi bi-emoji-smile"></i>
        </button>

        <div id="messageInput"
             class="form-control flex-grow-1"
             contenteditable="true"
             placeholder="Type your message"
             style="max-height: 100px; overflow-y: auto;">
        </div>

        <button id="sendBtn" class="btn btn-primary">Send</button>
    </div>
</div>

<div class="modal-backdrop fade" id="sidebar-backdrop" style="display: none;"></div>

<footer th:replace="~{/layout/footer.html}"></footer>

<script th:inline="javascript">
    const roomId = /*[[${roomId}]]*/ 0;
    const payload = getJwtPayload();
    const MY_USERNAME = payload?.username;

    let participants = [];
    let isFileBeingSent = false;

    const MAX_DIMENSION = 2000; // ê°€ì¥ ê¸´ ë³€ì˜ ìµœëŒ€ í•´ìƒë„ (í”½ì…€)
    const JPEG_QUALITY = 1; //0.8;   // ë¦¬ì‚¬ì´ì§• í›„ JPEG ì••ì¶• í’ˆì§ˆ (80%)
    const MAX_FILE_SIZE_BYTES = 10 * 1024 * 1024; // 10MB

    // ... ê¸°ì¡´ ë³€ìˆ˜ ì„ ì–¸ ì˜ì—­ (DOM Elements) ...
    const emojiBtn = document.getElementById("emojiBtn");
    const emojiPicker = document.getElementById("emojiPicker");
    const emojiSearchInput = document.getElementById("emojiSearchInput");
    const emojiListContainer = document.getElementById("emojiListContainer");

    // ... ê¸°ì¡´ ì „ì—­ ë³€ìˆ˜ ...
    let allEmojis = []; // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì „ì²´ ì´ëª¨ì§€ ëª©ë¡ ì €ì¥

    /**
     * ì„œë²„ì—ì„œ ì´ëª¨ì§€ ëª©ë¡ì„ ê°€ì ¸ì™€ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤.
     */
    async function fetchAllEmojis() {
        try {
            const res = await get('/file/emoji');
            if (!res.ok) throw new Error('Failed to load emojis.');
            allEmojis = await res.json();
            // ì´ˆê¸° ë¡œë“œ ì‹œ ì „ì²´ ì´ëª¨ì§€ ë Œë”ë§
            renderEmojis(allEmojis);
        } catch (e) {
            console.error('Fetch Emojis Error:', e);
            emojiListContainer.innerHTML = '<p class="text-center text-danger w-100 mt-3 small">Failed to load emojis.</p>';
        }
    }

    /**
     * ì´ëª¨ì§€ ëª©ë¡ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
     * @param {Array<Object>} list - ë Œë”ë§í•  FileDTO ëª©ë¡
     */
    function renderEmojis(list) {
        emojiListContainer.innerHTML = '';

        if (list.length === 0) {
            emojiListContainer.innerHTML = '<p class="text-center text-secondary w-100 mt-3 small">No matching emojis found.</p>';
            return;
        }

        list.forEach(item => {
            const div = document.createElement('div');
            div.className = 'emoji-item-chat';
            div.title = item.name; // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì´ë¦„ í‘œì‹œ

            const imgEl = document.createElement('img');
            imgEl.src = encodePathForSrc(item.directory);
            imgEl.alt = item.name || 'emoji';
            div.appendChild(imgEl);

            // ğŸš© í´ë¦­ ì‹œ ì…ë ¥ì°½ì— ì´ëª¨ì§€ í…ìŠ¤íŠ¸ ì‚½ì…
            div.addEventListener('click', () => insertEmojiToInput(item.directory, item.name));

            emojiListContainer.appendChild(div);
        });
    }

    /**
     * ì´ëª¨ì§€ ì´ë¦„ì„ ê¸°ë°˜ìœ¼ë¡œ ëª©ë¡ì„ í•„í„°ë§í•˜ê³  ë Œë”ë§í•©ë‹ˆë‹¤.
     */
    function filterAndRenderEmojis() {
        const searchTerm = emojiSearchInput.value.toLowerCase().trim();

        if (!searchTerm) {
            renderEmojis(allEmojis);
            return;
        }

        // ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ì— í•„í„°ë§ ìš”ì²­
        // '/file/emoji/{filename}' ì‚¬ìš©
        get(`/file/emoji/${encodeURIComponent(searchTerm)}`)
            .then(res => res.json())
            .then(filteredList => {
                renderEmojis(filteredList || []);
            })
            .catch(e => {
                console.error('Search Emojis Error:', e);
                emojiListContainer.innerHTML = '<p class="text-center text-danger w-100 mt-3 small">Search failed.</p>';
            });
    }


    /**
     * ì„ íƒëœ ì´ëª¨ì§€ë¥¼ ë©”ì‹œì§€ ì…ë ¥ì°½ì— ì‚½ì…í•©ë‹ˆë‹¤.
     * @param {string} directory - ì´ëª¨ì§€ íŒŒì¼ ê²½ë¡œ
     * @param {string} name - ì´ëª¨ì§€ íŒŒì¼ ì´ë¦„
     */
    function insertEmojiToInput(directory, name) {
        const input = document.getElementById("messageInput");

        // ğŸš© [ìˆ˜ì •] í…ìŠ¤íŠ¸ ëŒ€ì‹  <img> íƒœê·¸ë¥¼ ì‚½ì…í•©ë‹ˆë‹¤.
        const imgSrc = encodePathForSrc(directory);
        const emojiHtml = `<img src="${imgSrc}" alt="${name}"
                          class="inserted-emoji" style="max-width: 100%; max-height: 4rem; border-radius: 10px; vertical-align: middle;">`;

        // HTMLì„ ì¶”ê°€í•©ë‹ˆë‹¤.
        // ì£¼ì˜: ìºëŸ¿ ìœ„ì¹˜ì— ì‚½ì…í•˜ê¸° ìœ„í•´ ë³µì¡í•œ ë¡œì§ì´ í•„ìš”í•˜ì§€ë§Œ,
        // ê°„ë‹¨íˆ í˜„ì¬ ì½˜í…ì¸  ë’¤ì— ì¶”ê°€í•˜ë„ë¡ êµ¬í˜„í•©ë‹ˆë‹¤.
        input.innerHTML += emojiHtml;

        input.focus();

        // ì»¤ì„œë¥¼ ì‚½ì…ëœ ì´ëª¨ì§€ ë’¤ë¡œ ì´ë™ì‹œí‚¤ëŠ” ë¡œì§ (UX ê°œì„ )
        const selection = window.getSelection();
        const range = document.createRange();
        range.selectNodeContents(input);
        range.collapse(false); // ëìœ¼ë¡œ ì´ë™
        selection.removeAllRanges();
        selection.addRange(range);
    }

    // ------------------------------------------------
    // 1. WebSocket / STOMP Logic
    // ------------------------------------------------

    // (êµ¬í˜„ ë‚´ìš©ì€ ë³€ê²½ ì—†ìŒ - DTO êµ¬ì¡°ëŠ” í˜„ì¬ ìƒíƒœ ìœ ì§€)
    function subscribeAndSendEnter() {
        // ë©”ì‹œì§€ êµ¬ë…
        stompClient.subscribe(`/topic/rooms/${roomId}`, msg => {
            const message = JSON.parse(msg.body);
            addMessage(message);
        });

        // ChatDTO.Participant ëª©ë¡ ìˆ˜ì‹ 
        stompClient.subscribe(`/topic/rooms/${roomId}/participants`, msg => {
            const users = JSON.parse(msg.body);
            updateUsers(users);
        });

        // ì…ì¥ ë©”ì‹œì§€ ì „ì†¡
        stompClient.send("/app/chat.enter", {}, JSON.stringify({roomId: roomId}));
    }

    function disconnectWebSocket() {
        if (stompClient && stompClient.connected) {
            // í‡´ì¥ ë©”ì‹œì§€ ì „ì†¡
            stompClient.send("/app/chat.leave", {}, JSON.stringify({roomId: roomId}));

            stompClient.disconnect(() => {
                console.log("WebSocket disconnected");
            });
        }
        stompClient = null;
    }

    function sendMessage(text) {
        if (!text || !stompClient || !stompClient.connected) return;
        // TALK ë©”ì‹œì§€ ì „ì†¡
        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({roomId: roomId, message: text}));
    }

    // ------------------------------------------------
    // 2. UI Rendering Logic
    // ------------------------------------------------

    function renderAvatar(profileImageUrl) {
        const imageUrl = profileImageUrl && profileImageUrl !== 'null' ? profileImageUrl : DEFAULT_AVATAR_PATH;
        return imageUrl;
    }

    function getUserInfoString(user) {
        if (!user) return '{}';
        return JSON.stringify({
            id: user.id,
            username: user.username,
            displayName: user.displayName,
            profileImage: user.profileImage,
        }).replaceAll('"', '&quot;');
    }

    function getParticipantInfoString(p) {
        if (!p) return '{}';
        return JSON.stringify({
            id: p.userId,
            username: p.username,
            displayName: p.displayName,
            profileImage: p.profileImage,
        }).replaceAll('"', '&quot;');
    }

    // ë©”ì‹œì§€ì— HTML íƒœê·¸ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (íŒŒì¼ ë©”ì‹œì§€ ì—¬ë¶€ íŒë‹¨)
    function isFileMessage(message) {
        if (!message || !message.message) return false;
        const content = message.message.trim();
        return content.includes('<img') || content.includes('<video');
    }

    function addMessage(message) {
        const container = document.getElementById("chatContainer");
        const div = document.createElement("div");
        const user = message.user;

        // ğŸš© íŒŒì¼ ë©”ì‹œì§€ ì—¬ë¶€ í”Œë˜ê·¸
        const isFileMsg = isFileMessage(message);

        // ğŸš© ì‘ì„± ì‹œê°„ í¬ë§·íŒ…
        const formattedTime = getDateTimeFormat(message.createdAt);

        if (message.type === "ENTER" || message.type === "LEAVE") {
            // ... (ì‹œìŠ¤í…œ ë©”ì‹œì§€ ë¡œì§ ìœ ì§€) ...
            const userName = user?.displayName || 'A user';
            div.textContent = `${userName} has ${message.type === "ENTER" ? "joined" : "left"}`;
            div.classList.add("system-msg");

        } else { // TALK
            const isMine = MY_USERNAME === user?.username;

            // ë˜í¼ í´ë˜ìŠ¤ ì¶”ê°€
            div.classList.add("message-wrap", "d-flex", "align-items-end", isMine ? "justify-content-end" : "justify-content-start");

            const userInfoStr = getUserInfoString(user);

            // ğŸš© ì‹œê°„ í‘œì‹œ ì˜ì—­ DOM ìƒì„±
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time small';
            timeDiv.innerText = formattedTime;

            // ğŸš© ë©”ì‹œì§€ ë‚´ìš© DIV
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message");
            messageDiv.classList.add(isMine ? "mine" : "other");

            // ğŸš© ë©”ì‹œì§€ ë‚´ìš© ì„¤ì • (ì¤‘ìš” ìˆ˜ì •)
            if (isFileMsg) {
                // ğŸš© íŒŒì¼ ë©”ì‹œì§€: HTMLì„ ê·¸ëŒ€ë¡œ ì‚½ì… (XSS ìœ„í—˜ ì£¼ì˜)
                messageDiv.innerHTML = message.message;
                // ìº¡ì…˜ì´ <p class="file-caption">ìœ¼ë¡œ í¬í•¨ë˜ì–´ ìˆë‹¤ê³  ê°€ì •
            } else {
                // ğŸš© ì¼ë°˜ í…ìŠ¤íŠ¸ ë©”ì‹œì§€: escape ì²˜ë¦¬ í•„ìˆ˜
                messageDiv.innerHTML = `<span class="text-break">${escapeHtml(message.message)}</span>`;
            }

            if (!isMine) {
                const userName = user?.displayName || 'User';
                const avatarUrl = renderAvatar(user?.profileImage);

                // ğŸš© 'other' ë©”ì‹œì§€ êµ¬ì¡° ì¬êµ¬ì„±: ì•„ë°”íƒ€, ì´ë¦„, ë‚´ìš©, ì‹œê°„
                const contentHtml = `
                <div class="avatar-wrap">
                    <img src="${avatarUrl}"
                         onclick="showUserInfoModal(JSON.parse(unescapeHtml('${userInfoStr}')))"
                         alt="Avatar" class="user-avatar">
                </div>
                <div class="message-content">
                    <span class="sender-name">${userName}</span>
                    ${messageDiv.innerHTML}
                    ${timeDiv.outerHTML}
                </div>
            `;
                // 'other' ë©”ì‹œì§€ì˜ ê²½ìš°, ì „ì²´ ë‚´ìš©ì„ messageDivê°€ ì•„ë‹Œ message-content ë‚´ë¶€ì— ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.
                // ê¸°ì¡´ êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ messageDivì˜ ë‚´ìš©ì„ message-contentì— ë„£ëŠ” ë°©ì‹ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.

                // messageDivë¥¼ ë˜í¼ë¡œ ì‚¬ìš©í•˜ì§€ ì•Šê³ , ë‚´ìš©ë¬¼ë§Œ ì¶”ì¶œí•˜ì—¬ ì‚¬ìš©
                const messageContentInner = isFileMsg ? message.message : `<span class="text-break">${escapeHtml(message.message)}</span>`;

                messageDiv.innerHTML = `
                <div class="avatar-wrap">
                    <img src="${avatarUrl}"
                         onclick="showUserInfoModal(JSON.parse(unescapeHtml('${userInfoStr}')))"
                         alt="Avatar" class="user-avatar">
                </div>
                <div class="message-content">
                    <span class="sender-name">${userName}</span>
                    ${messageContentInner}
                    ${timeDiv.outerHTML}
                </div>
            `;
                div.appendChild(messageDiv);

            } else {
                // ğŸš© 'mine' ë©”ì‹œì§€
                // ì‹œê°„ì€ ë©”ì‹œì§€ ë’¤ì— ìœ„ì¹˜í•˜ë„ë¡ ë˜í¼ divì— ì¶”ê°€

                messageDiv.innerHTML = isFileMsg
                    ? message.message
                    : `<span class="text-break">${escapeHtml(message.message)}</span>`;

                messageDiv.appendChild(timeDiv); // ğŸš© ì‹œê°„ ë¨¼ì €
                div.appendChild(messageDiv); // ğŸš© ë©”ì‹œì§€ ë‚˜ì¤‘
            }
        }

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;

        if (isFileMsg) {
            // ë©”ì‹œì§€ DIV ë‚´ë¶€ì—ì„œ ë¯¸ë””ì–´ ìš”ì†Œ (img.file-image ë˜ëŠ” .video-thumbnail-wrap)ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            const mediaElement = div.querySelector('.file-image, .video-thumbnail-wrap');

            if (mediaElement) {
                mediaElement.addEventListener('click', function(e) {
                    e.stopPropagation(); // ì¤‘ì²©ëœ í´ë¦­ ë°©ì§€

                    const url = this.getAttribute('data-url');
                    const type = this.getAttribute('data-type');

                    if (url && type) {
                        showMediaModal(url, type); // ğŸš© ìƒˆë¡œ ì •ì˜í•œ ëª¨ë‹¬ í•¨ìˆ˜ í˜¸ì¶œ
                    }
                });
            }
        }
    }

    function updateUsers(users) {
        const container = document.getElementById("participantsList");
        container.innerHTML = "";
        participants = users;

        const count = users.length;
        document.getElementById("desktop-participant-count").textContent = count;
        document.getElementById("mobile-participant-count").textContent = count;

        users.forEach(u => {
            const isMine = MY_USERNAME === u.username;
            const displayName = u.displayName || u.username || 'Unknown';
            const participantInfo = getParticipantInfoString(u);

            const div = document.createElement("div");
            div.classList.add("participant");

            div.onclick = (event) => {
                event.stopPropagation();
                showUserInfoModal(JSON.parse(unescapeHtml(participantInfo)));
            };

            const avatarUrl = renderAvatar(u.profileImage);

            div.innerHTML = `
                <img src="${avatarUrl}" alt="Avatar" class="user-avatar" style="cursor: default;">
                <span class="participant-name">${displayName}</span>
                ${isMine ? '<span class="badge text-bg-info ms-auto">Me</span>' : ''}
            `;
            container.appendChild(div);
        });
    }

    // ------------------------------------------------
    // 3. User Info Modal Logic (ğŸš© commonModalë¡œ ë¦¬íŒ©í† ë§)
    // ------------------------------------------------

    /**
     * ì‚¬ìš©ì ì •ë³´ë¥¼ commonModalì— í‘œì‹œí•˜ê³  ë„ì›ë‹ˆë‹¤.
     * @param {Object} userData - í‘œì‹œí•  ì‚¬ìš©ì ë°ì´í„° (id, username, displayName, profileImage í¬í•¨)
     */
    function showUserInfoModal(userData) {
        if (!userData) {
            console.error("User Data missing.", userData);
            return;
        }

        const avatarUrl = renderAvatar(userData.profileImage);

        // ğŸš© commonModal bodyì— ë“¤ì–´ê°ˆ HTML ìƒì„±
        const bodyHtml = `
            <div class="text-center">
                <img src="${avatarUrl}" alt="Profile" class="user-modal-avatar mb-3">
                <h4 class="fw-bold mb-1">${userData.displayName || 'N/A'}</h4>
                <p class="small mb-3">@${userData.username || 'Unknown'}</p>
                ${userData.id ? `<p class="small mb-0">Member ID: ${userData.id}</p>` : ''}
            </div>
        `;

        // ğŸš© showModal ì „ì—­ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë‹¬ í‘œì‹œ
        // actionFn: null (í™•ì¸ ë²„íŠ¼ ì—†ìŒ), options: { showClose: true } (ë‹«ê¸° ë²„íŠ¼ë§Œ í‘œì‹œ)
        showModal(
            "User Information",
            bodyHtml,
            null,
            {
                center: true, // ì¤‘ì•™ ì •ë ¬ ì¶”ê°€
                customModalClass: 'modal-sm' // ëª¨ë‹¬ í¬ê¸°ë¥¼ ì‘ê²Œ ì¡°ì •
            }
        );
    }


    // HTML Escape Helper (ë³€ê²½ ì—†ìŒ)
    function escapeHtml(s) {
        if (!s) return '';
        return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;');
    }


    // HTML Unescape Helper (ë³€ê²½ ì—†ìŒ)
    function unescapeHtml(s) {
        if (!s) return '';
        return s.replaceAll('&quot;', '"').replaceAll('&#039;', "'").replaceAll('&lt;', '<').replaceAll('&gt;', '>').replaceAll('&amp;', '&');
    }

    // ------------------------------------------------
    // 4. File Upload Logic (ë³€ê²½ ì—†ìŒ)
    // ------------------------------------------------

    function resetFileInput() {
        const fileInput = document.getElementById("fileInput");
        fileInput.value = '';
        isFileBeingSent = false;
    }

    function validateFile(file) {
        if (!file) {
            return "No file selected.";
        }

        const mimeType = file.type;
        if (!mimeType.startsWith('image/') && !mimeType.startsWith('video/')) {
            return "Only images and videos are allowed (image/* or video/*).";
        }

        if (file.size > MAX_FILE_SIZE_BYTES) {
            const maxMb = (MAX_FILE_SIZE_BYTES / 1024 / 1024).toFixed(1);
            const fileMb = (file.size / 1024 / 1024).toFixed(2);
            return `File size (${fileMb}MB) exceeds the maximum limit (${maxMb}MB).`;
        }

        return null;
    }

    function renderPreviewHtml(file) {
        const fileUrl = URL.createObjectURL(file);
        let mediaHtml = '';

        if (file.type.startsWith('image/')) {
            mediaHtml = `<img src="${fileUrl}" alt="Preview" class="d-block w-100 h-100">`;
        } else if (file.type.startsWith('video/')) {
            mediaHtml = `<video src="${fileUrl}" controls autoplay muted class="d-block w-100 h-100"></video>`;
        } else {
            mediaHtml = `<span class="text-danger">Unsupported file type for preview.</span>`;
        }

        const bodyHtml = `
            <p id="fileNameDisplay" class="mb-2 small">${file.name}</p>
            <div id="previewContent" class="d-flex justify-content-center align-items-center preview-content">
                ${mediaHtml}
            </div>
            <textarea id="fileCaption" class="form-control mt-3" placeholder="Add a caption (optional)" rows="2"
                      style="background-color: var(--cf-dark-bg-primary); color: var(--cf-text-primary); border-color: var(--cf-border-color);"></textarea>

            <p class="mt-2 small text-warning">Note: The file will be sent once you click 'Confirm'.</p>
        `;
        return bodyHtml;
    }

    /**
     * ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•˜ê³ , ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©° ìµœëŒ€ í•´ìƒë„(MAX_DIMENSION)ë¡œ ë‹¤ìš´ìŠ¤ì¼€ì¼ë§í•˜ì—¬ ìƒˆë¡œìš´ Blobìœ¼ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
     * ë¹„ë””ì˜¤ íŒŒì¼ì€ ì›ë³¸ ê·¸ëŒ€ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
     */
    async function resizeImage(file) {
        if (!file.type.startsWith('image/') || file.type === 'image/gif') {
            return file;
        }

        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function (event) {
                const img = new Image();
                img.onload = function () {
                    let width = img.width;
                    let height = img.height;

                    // 1. ë¦¬ì‚¬ì´ì§•ì´ í•„ìš”í•œì§€ í™•ì¸
                    if (width <= MAX_DIMENSION && height <= MAX_DIMENSION) {
                        resolve(file); // ë¦¬ì‚¬ì´ì§• ë¶ˆí•„ìš”, ì›ë³¸ íŒŒì¼ ë°˜í™˜
                        return;
                    }

                    // 2. ìƒˆë¡œìš´ í¬ê¸° ê³„ì‚° (ë¹„ìœ¨ ìœ ì§€)
                    let ratio = Math.min(MAX_DIMENSION / width, MAX_DIMENSION / height);
                    width *= ratio;
                    height *= ratio;

                    // 3. ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // 4. Blobìœ¼ë¡œ ë³€í™˜
                    canvas.toBlob((blob) => {
                        if (blob) {
                            // Blobì„ File ê°ì²´ë¡œ ë³€í™˜í•˜ì—¬ ë°˜í™˜
                            const resizedFile = new File([blob], file.name, {
                                type: file.type,
                                lastModified: Date.now()
                            });
                            resolve(resizedFile);
                        } else {
                            reject(new Error("Canvas to Blob failed."));
                        }
                    }, file.type, JPEG_QUALITY); // JPEG í’ˆì§ˆ ì§€ì •
                };
                img.onerror = function (e) {
                    reject(e);
                };
                img.src = event.target.result;
            };
            reader.onerror = function (e) {
                reject(e);
            };
            reader.readAsDataURL(file);
        });
    }

    /**
     * íŒŒì¼ ì „ì†¡ ë¡œì§ (showModalì˜ Confirm ì•¡ì…˜)
     */
    async function sendFileAction(resizedFile) {
        const file = resizedFile;

        // ìº¡ì…˜ í•„ë“œ ê°€ì ¸ì˜¤ê¸°
        const caption = document.getElementById('fileCaption')?.value || '';

        if (!file || !stompClient || !stompClient.connected) {
            showAlert("File or connection missing. Cannot send file.", 'danger');
            resetFileInput();
            return;
        }

        isFileBeingSent = true;
        showAlert(`Uploading ${file.name}...`, 'info');

        try {
            const formData = new FormData();

            // 1. íŒŒì¼ (ë°±ì—”ë“œ @RequestPart("file"))
            formData.append('file', file);

            // 2. ë©”ì‹œì§€ ê´€ë ¨ ë°ì´í„° (ë°±ì—”ë“œ @RequestPart("roomId")ì™€ @RequestPart("message"))
            // formData.append('roomId', roomId);
            formData.append('message', caption); // ìº¡ì…˜ = ë©”ì‹œì§€ ë³¸ë¬¸

            // ğŸš© ë°±ì—”ë“œ ê´€ë¦¬ì URIì— ë§ì¶° ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •
            const response = await httpFileRequest('/admin/file/upload-chat/' + roomId, formData);

            if (response.ok) {
                showAlert(`File ${file.name} sent successfully.`, 'success');
                // ì„±ê³µ ì‹œ ì„œë²„ëŠ” WebSocketìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë¸Œë¡œë“œìºìŠ¤íŠ¸í•  ê²ƒì…ë‹ˆë‹¤.
            } else {
                const errorText = await response.text();
                showAlert(`File upload failed: ${response.status} - ${errorText}`, 'danger');
            }

        } catch (error) {
            console.error("File upload network error:", error);
            showAlert("Network error during file upload.", 'danger');
        } finally {
            resetFileInput();
        }
    }

    // ------------------------------------------------
    // 5. Event Handlers & Initialization (ë³€ê²½ ì—†ìŒ)
    // ------------------------------------------------
    document.getElementById("toggleParticipantsBtn").addEventListener('click', () => {
        const sidebar = document.getElementById("participantsSidebar");
        const backdrop = document.getElementById("sidebar-backdrop");

        const isOpen = sidebar.classList.toggle('open');

        if (window.innerWidth <= 1200) {
            backdrop.style.display = isOpen ? 'block' : 'none';
        }
    });

    document.getElementById("sidebar-backdrop").addEventListener('click', () => {
        document.getElementById("participantsSidebar").classList.remove('open');
        document.getElementById("sidebar-backdrop").style.display = 'none';
    });

    window.addEventListener('resize', () => {
        const sidebar = document.getElementById("participantsSidebar");
        const backdrop = document.getElementById("sidebar-backdrop");
        if (window.innerWidth > 1200) {
            sidebar.classList.remove('open');
            backdrop.style.display = 'none';
        }
    });

    document.addEventListener("DOMContentLoaded", () => {
        // 1. WebSocket ì—°ê²° ë° êµ¬ë…/ì…ì¥ ë©”ì‹œì§€ ì „ì†¡
        connectWebSocket(subscribeAndSendEnter);

        // 2. ì´ì „ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
        get(`/api/chat/rooms/${roomId}/messages`)
            .then(res => res.json())
            .then(messages => {
                if (messages && messages.length > 0) {
                    messages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt)).forEach(addMessage);
                } else {
                    addMessage({type: "SYSTEM", message: "Start chatting now!"});
                }
            })
            .catch(error => {
                console.error("Failed to load history:", error);
                addMessage({type: "SYSTEM", message: "Failed to load chat history."});
            });


        // 3. ë©”ì‹œì§€ ì „ì†¡ ì´ë²¤íŠ¸
        const input = document.getElementById("messageInput");
        const sendBtn = document.getElementById("sendBtn");

        const handleSend = () => {
            const content = input.innerHTML.trim();
            if (content) {
                sendMessage(content); // ğŸš© ë³€ê²½: í…ìŠ¤íŠ¸ ëŒ€ì‹  HTML ì½˜í…ì¸  ì „ì†¡
                input.innerHTML = ""; // ğŸš© ë³€ê²½: input.value ëŒ€ì‹  innerHTML ì‚¬ìš©
                input.focus();
            }
        }

        input.addEventListener("keydown", e => {
            if (e.key === "Enter") {
                e.preventDefault();
                handleSend();
            }
        });
        sendBtn.addEventListener("click", handleSend);

        // 4. íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        const fileInput = document.getElementById("fileInput");
        const commonModalElement = document.getElementById('commonModal');

        document.getElementById("attachFileBtn")?.addEventListener("click", () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', async (e) => { // ğŸš© async ì¶”ê°€
            const originalFile = e.target.files[0];
            if (!originalFile) return;

            const error = validateFile(originalFile);

            if (error) {
                showAlert(error, 'warning');
                resetFileInput();
                return;
            }

            // ğŸš© ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
            showAlert(`Processing ${originalFile.name}...`, 'info');

            let fileToUpload = originalFile;

            // ğŸš© ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§• ì‹¤í–‰ (ë¹„ë™ê¸°)
            try {
                fileToUpload = await resizeImage(originalFile);
                showAlert(fileToUpload.type.startsWith('image/') ? 'Image resized successfully.' : 'File processing complete.', 'success', 2000);
            } catch (resizeError) {
                console.error("Image resizing failed:", resizeError);
                showAlert("Image processing failed. Sending original file.", 'warning');
            }

            // ğŸš© ë¦¬ì‚¬ì´ì§•ëœ íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ ë¯¸ë¦¬ë³´ê¸° HTML ìƒì„±
            const bodyHtml = renderPreviewHtml(fileToUpload);

            // ğŸš© showModalì˜ Confirm ì•¡ì…˜ì— ë¦¬ì‚¬ì´ì§•ëœ íŒŒì¼ ê°ì²´ë¥¼ ì „ë‹¬í•˜ëŠ” í´ë¡œì € í•¨ìˆ˜ ì‚¬ìš©
            showModal(
                "File Preview: " + fileToUpload.name,
                bodyHtml,
                () => sendFileAction(fileToUpload), // ğŸš© í´ë¡œì €ë¥¼ í†µí•´ íŒŒì¼ ê°ì²´ ì „ë‹¬
                {isStatic: true, showClose: true}
            );
        });

        document.getElementById("emojiBtn").addEventListener("click", () => {
            const isVisible = emojiPicker.style.display === 'block';
            if (isVisible) {
                emojiPicker.style.display = 'none';
            } else {
                // ì´ëª¨ì§€ ëª©ë¡ì´ ë¹„ì–´ìˆë‹¤ë©´, ëª©ë¡ì„ ë¡œë“œí•©ë‹ˆë‹¤.
                if (allEmojis.length === 0) {
                    fetchAllEmojis();
                } else {
                    renderEmojis(allEmojis); // ì´ë¯¸ ë¡œë“œëœ ëª©ë¡ì´ ìˆìœ¼ë©´ ë°”ë¡œ í‘œì‹œ
                }
                emojiSearchInput.value = ''; // ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
                emojiPicker.style.display = 'block';
            }
        });

        // ğŸš© [ì¶”ê°€] ì´ëª¨ì§€ ê²€ìƒ‰ ì…ë ¥ ì´ë²¤íŠ¸ (ë””ë°”ìš´ìŠ¤ í•„ìš”)
        let searchTimeout;
        emojiSearchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterAndRenderEmojis, 300); // 0.3ì´ˆ ë””ë°”ìš´ìŠ¤
        });

        commonModalElement?.addEventListener('hidden.bs.modal', function (event) {
            if (!isFileBeingSent) {
                resetFileInput();
            }
        });

        // 5. í˜ì´ì§€ ì´íƒˆ ì‹œ ì²˜ë¦¬
        const handleLeave = () => {
            disconnectWebSocket();
        };

        window.addEventListener("pagehide", handleLeave);
        window.addEventListener("beforeunload", handleLeave);
    });
</script>
</body>
</html>