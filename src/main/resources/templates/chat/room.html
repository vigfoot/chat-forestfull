<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chat Room</title>
    <script src="/webjars/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/2.3.4/stomp.min.js"></script>
    <script src="/js/script.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            background: #f4f6f9;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: #4a90e2;
            color: #fff;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .back-btn {
            cursor: pointer;
            background: #fff;
            color: #4a90e2;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 14px;
            border: none;
        }

        .chat-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .participants {
            width: 200px;
            background: #fff;
            border-right: 1px solid #ddd;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .participants h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 6px;
        }

        .participant {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }

        .participant img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #eee;
        }

        #chatContainer {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #f9f9f9;
        }

        .message {
            padding: 12px 16px;
            border-radius: 14px;
            max-width: 75%;
            font-size: 15px;
            animation: fadeIn 0.25s ease;
            word-wrap: break-word;
        }

        .mine {
            margin-left: auto;
            background: #4a90e2;
            color: #fff;
            border-bottom-right-radius: 2px;
        }

        .other {
            background: #ffffff;
            color: #333;
            border-bottom-left-radius: 2px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        .system-msg {
            text-align: center;
            color: #888;
            font-size: 14px;
        }

        .input-wrap {
            display: flex;
            padding: 12px;
            background: #ffffff;
            border-top: 1px solid #ddd;
            gap: 10px;
        }

        #messageInput {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #ccc;
            font-size: 15px;
        }

        #sendBtn {
            padding: 12px 18px;
            border: none;
            background: #4a90e2;
            color: #fff;
            font-size: 15px;
            border-radius: 10px;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
<div class="header">
    <button class="back-btn" onclick="location.href='/pages/rooms'">← Rooms</button>
    Room #<span th:text="${roomId}"></span>
</div>

<div class="chat-wrapper">
    <div class="participants">
        <h4>참여자</h4>
        <div id="participantsList"></div>
    </div>
    <div id="chatContainer"></div>
</div>

<div class="input-wrap">
    <input type="text" id="messageInput" placeholder="메시지를 입력하세요">
    <button id="sendBtn">Send</button>
</div>

<script th:inline="javascript">
    const roomId = /*[[${roomId}]]*/ 0;
    const payload = getJwtPayload(); // JWT_PAYLOAD 읽기
    const MY_ID = Number(payload?.sub);
    const MY_NAME = payload?.username;
    const MY_DISPLAY_NAME = payload?.displayName;
    const MY_PROFILE_IMAGE = payload?.profileImage;
    let reconnectInterval = 5000;

    function connectWebSocket() {
        const socket = new SockJS("/ws/chat");
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, () => {
            console.log("WebSocket 연결 성공");

            // 메시지 구독
            stompClient.subscribe(`/topic/rooms/${roomId}`, msg => {
                const message = JSON.parse(msg.body);
                addMessage(message);
            });

            // 참여자 리스트 구독
            stompClient.subscribe(`/topic/rooms/${roomId}/participants`, msg => {
                const users = JSON.parse(msg.body);
                updateUsers(users);
            });

            stompClient.send("/app/chat.enter", {}, JSON.stringify({
                roomId,
                user: {
                    id: MY_ID,
                    name: MY_NAME,
                    displayName: MY_DISPLAY_NAME,
                    profileImage: MY_PROFILE_IMAGE,
                }
            }));
        }, error => {
            console.error("WebSocket 연결 실패:", error);
            setTimeout(connectWebSocket, reconnectInterval);
        });
    }

    // **[FIX]** disconnectWebSocket 함수: STOMP 연결을 종료합니다.
    function disconnectWebSocket() {
        if (stompClient && stompClient.connected) {
            stompClient.disconnect(() => {
                console.log("WebSocket 연결 종료");
            });
        }
        // STOMP 객체 자체를 초기화하여 재연결 방지 (선택적)
        stompClient = null;
    }

    function sendMessage(text) {
        if (!text) return;
        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
            roomId: roomId,
            user: {
                id: MY_ID,
                name: MY_NAME,
                displayName: MY_DISPLAY_NAME,
                profileImage: MY_PROFILE_IMAGE,
            },
            type: "TALK",
            message: text
        }));
    }

    // **[FIX]** leaveRoom 함수: 서버에 퇴장 메시지를 전송합니다.
    function leaveRoom() {
        if (!stompClient || !stompClient.connected) return;

        // 서버에 LEAVE 메시지를 보냄
        stompClient.send("/app/chat.leave", {}, JSON.stringify({
            roomId: roomId,
            user: {
                id: MY_ID,
                name: MY_NAME,
                displayName: MY_DISPLAY_NAME,
                profileImage: MY_PROFILE_IMAGE,
            }
        }));
    }

    function addMessage(message) {
        const container = document.getElementById("chatContainer");
        const div = document.createElement("div");

        if (message.type === "ENTER") {
            div.textContent = `${message.user.displayName}님이 입장했습니다`;
            div.classList.add("system-msg");
        } else if (message.type === "LEAVE") {
            div.textContent = `${message.user.displayName}님이 퇴장했습니다`;
            div.classList.add("system-msg");
        } else { // TALK
            div.classList.add("message");
            div.classList.add(MY_ID === message.user.id ? "mine" : "other");

            if (MY_ID !== message.user.id) {
                const avatar = document.createElement("img");
                avatar.src = message.user.profileImage || "/img/default-avatar.png";
                avatar.classList.add("user-avatar");
                div.appendChild(avatar);
            }

            const textSpan = document.createElement("span");
            textSpan.textContent = message.message;
            div.appendChild(textSpan);
        }

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function updateUsers(users) {
        const container = document.getElementById("participantsList");
        container.innerHTML = "";
        users.forEach(u => {
            const div = document.createElement("div");
            div.classList.add("participant");

            const avatar = document.createElement("img");
            avatar.src = u.user.profileImage || "/img/default-avatar.png";

            const name = document.createElement("span");
            name.textContent = u.user.name;

            div.appendChild(avatar);
            div.appendChild(name);
            container.appendChild(div);
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        connectWebSocket();

        // 이전 메시지 불러오기
        fetch(`/api/chat/rooms/${roomId}/messages`, {credentials: 'include'})
            .then(res => res.json())
            .then(messages => {
                messages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt)).forEach(addMessage);
            });

        // 메시지 전송 이벤트
        const input = document.getElementById("messageInput");
        const sendBtn = document.getElementById("sendBtn");

        input.addEventListener("keydown", e => {
            if (e.key === "Enter" && input.value.trim()) {
                sendMessage(input.value.trim());
                input.value = "";
            }
        });

        sendBtn.addEventListener("click", () => {
            if (input.value.trim()) {
                sendMessage(input.value.trim());
                input.value = "";
            }
        });

        const handleLeave = () => {
            leaveRoom();// 1. 서버에 퇴장 메시지를 보냄 (필수)
            disconnectWebSocket();// 2. WebSocket 연결을 끊음 (선택적이지만 권장)
        };

        // 기존 beforeunload 대신 pagehide를 사용합니다.
        // **[FIX]** beforeunload를 pagehide로 변경하거나, 둘 다 사용
        window.addEventListener("pagehide", handleLeave);
        // beforeunload는 탭/창을 닫을 때 확실히 동작하도록 유지
        window.addEventListener("beforeunload", handleLeave);
    });
</script>
</body>
</html>