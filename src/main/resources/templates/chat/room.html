<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Chat Room</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.js"></script>
    <script src="/js/script.js"></script>
</head>

<body>

<h2 id="roomName">Loading...</h2>

<div id="chatArea" style="border:1px solid #ccc; width:400px; height:300px; overflow:auto;"></div>

<input type="text" id="msgInput" placeholder="ë©”ì‹œì§€ë¥¼ ìž…ë ¥í•˜ì„¸ìš”" autocomplete="off" />
<button onclick="sendMessage()">ì „ì†¡</button>

<script>
    let roomId = new URLSearchParams(location.search).get("roomId");

    async function init() {
        document.getElementById("roomName").innerText = `ì±„íŒ…ë°© #${roomId}`;

        connectWebSocket(() => {
            stompClient.subscribe(`/sub/chat/${roomId}`, (msg) => {
                const body = JSON.parse(msg.body);
                addMessage(body);
            });

            stompClient.send(`/pub/chat/enter/${roomId}`, {}, JSON.stringify({
                roomId,
                type: "ENTER"
            }));
        });
    }

    function addMessage(msg) {
        const chatArea = document.getElementById("chatArea");
        const div = document.createElement("div");

        if (msg.type === "ENTER") {
            div.innerText = `ðŸ”µ ${msg.sender} ë‹˜ ìž…ìž¥`;
        } else if (msg.type === "LEAVE") {
            div.innerText = `ðŸ”¸ ${msg.sender} ë‹˜ í‡´ìž¥`;
        } else {
            div.innerText = `${msg.sender}: ${msg.message}`;
        }

        chatArea.appendChild(div);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById("msgInput");
        const text = input.value.trim();
        if (!text) return;

        stompClient.send(`/pub/chat/${roomId}`, {}, JSON.stringify({
            message: text,
            type: "TALK"
        }));

        input.value = "";
    }

    window.onbeforeunload = () => {
        if (stompClient) {
            stompClient.send(`/pub/chat/leave/${roomId}`, {}, JSON.stringify({
                roomId,
                type: "LEAVE"
            }));
            disconnectWebSocket();
        }
    };

    init();
</script>

</body>
</html>