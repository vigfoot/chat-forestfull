<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <script th:replace="~{/layout/config.html}"></script>

    <style>
        /* Dark Theme overrides for the list card */
        .cf-rooms-card {
            background-color: var(--cf-dark-bg-secondary) !important;
            border: 1px solid var(--cf-border-color);
            color: var(--cf-text-primary);
        }

        .cf-rooms-card .list-group-item {
            background-color: transparent !important; /* Make items inherit card color */
            border-color: var(--cf-border-color);
            color: var(--cf-text-primary);
            padding: 1.25rem 1rem;
            cursor: pointer;
        }

        .cf-rooms-card .text-muted {
            color: var(--cf-text-secondary) !important;
        }

        /* Styling for the Primary Enter Button */
        .btn-enter {
            background-color: var(--cf-accent-primary) !important;
            border-color: var(--cf-accent-primary) !important;
            color: var(--cf-dark-bg-primary) !important;
            font-weight: bold;
            min-width: 90px;
        }

        .btn-enter:hover {
            filter: brightness(1.1);
        }

        /* Room participant count style */
        .room-participant-count {
            color: var(--cf-accent-primary);
            font-weight: bold;
            margin-left: 10px;
            font-size: 0.9em;
        }
    </style>

    <title>Chat ForestFull | Rooms</title>
</head>
<body class="d-flex flex-column min-vh-100">

<header th:replace="~{/layout/header.html}"></header>

<main class="container py-5 flex-grow-1">
    <div class="row justify-content-center">
        <div class="col-sm-12 col-md-10 col-lg-8">
            <div class="card cf-rooms-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3"
                     style="border-color: var(--cf-border-color) !important;">
                    <h4 class="mb-0 fw-bold">ğŸŒ³Room</h4>

                    <div class="d-flex align-items-center">
                        <small class="text-muted me-3" id="user-info">Loading user...</small>
                        <div sec:authorize="hasRole('ROLE_ADMIN')">
                            <button id="btn-create-room" class="btn btn-sm btn-primary fw-bold">
                                <i class="bi bi-plus-lg me-1"></i> Create Room
                            </button>
                        </div>
                    </div>
                </div>

                <ul id="rooms-list" class="list-group list-group-flush">
                </ul>

                <div class="mt-4 text-muted small text-center">
                    <i class="bi bi-info-circle me-1"></i> Click a room name or the 'Enter' button to join.
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{/layout/footer.html}"></footer>

<div class="modal fade" id="createRoomModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content cf-rooms-card">
            <div class="modal-header border-bottom" style="border-color: var(--cf-border-color) !important;">
                <h5 class="modal-title fw-bold">Create New Room</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input id="new-room-name" class="form-control" placeholder="Room name (required)"
                       style="background-color: var(--cf-dark-bg-primary); color: var(--cf-text-primary); border-color: var(--cf-border-color);"/>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="create-room-submit" class="btn btn-primary fw-bold">Create</button>
            </div>
        </div>
    </div>
</div>

<script src="/webjars/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/2.3.4/stomp.min.js"></script>
<script>
    (function () {
        // ì „ì—­ í•¨ìˆ˜ í˜¸ì¶œ: JWT Payloadì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
        const payload = getJwtPayload();
        const userDisplay = payload ? (payload.displayName || payload.name || ('#' + payload.sub)) : 'Guest';
        document.getElementById('user-info').innerText = `Logged in as ${userDisplay}`;

        const roomsList = document.getElementById('rooms-list');
        // ë¶€íŠ¸ìŠ¤íŠ¸ë© ëª¨ë‹¬ ì¸ìŠ¤í„´ìŠ¤
        const modal = new bootstrap.Modal(document.getElementById('createRoomModal'));

        // ğŸŸ¢ STOMP Client ì •ì˜ ë° ì„¤ì •
        let stompClient = null;
        // ğŸŸ¢ ParticipantServiceì—ì„œ ì‚¬ìš©í•˜ëŠ” í† í”½ê³¼ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
        const participantsTopic = '/topic/rooms/participants';

        // ğŸš© API URI ìƒìˆ˜ ì •ì˜
        const ROOMS_READ_URI = '/api/chat/rooms';
        const ROOMS_CREATE_URI = '/api/admin/chat/rooms';

        // ------------------------------------
        // ì›¹ì†Œì¼“ ì—°ê²° ë° êµ¬ë… ë¡œì§
        // ------------------------------------
        function connect() {
            if (stompClient && stompClient.connected) {
                return;
            }

            const socket = new SockJS('/ws/chat');
            stompClient = Stomp.over(socket);
            stompClient.debug = null;
            stompClient.connect({}, (frame) => {
                console.log('STOMP Connection established.');

                // ğŸŸ¢ ì¸ì›ìˆ˜ ì—…ë°ì´íŠ¸ í† í”½ êµ¬ë…
                stompClient.subscribe(participantsTopic, (message) => {
                    const update = JSON.parse(message.body);
                    handleParticipantUpdate(update);
                });

            }, (error) => {
                console.error('STOMP Connection failed:', error);
                setTimeout(connect, 5000);
            });
        }

        /**
         * ğŸŸ¢ ì›¹ì†Œì¼“ìœ¼ë¡œë¶€í„° ë°›ì€ ì¸ì›ìˆ˜ ì—…ë°ì´íŠ¸ ë©”ì‹œì§€ ì²˜ë¦¬
         * @param {Object} update - {roomId: number, count: number} êµ¬ì¡°
         */
        function handleParticipantUpdate(update) {
            const roomId = update.roomId;
            const newCount = update.count;
            // li ìš”ì†Œë¥¼ data-room-id ì†ì„±ì„ ì´ìš©í•´ ì°¾ìŠµë‹ˆë‹¤.
            const roomItem = document.querySelector(`li[data-room-id="${roomId}"]`);

            if (roomItem) {
                // ì¸ì›ìˆ˜ë¥¼ í‘œì‹œí•˜ëŠ” span ìš”ì†Œë¥¼ ì°¾ìŠµë‹ˆë‹¤.
                const countElement = roomItem.querySelector('.participant-count-value');
                if (countElement) {
                    countElement.innerText = newCount;
                }
            }
        }
        // ------------------------------------

        async function loadRooms() {
            try {
                // get() í•¨ìˆ˜ëŠ” ì „ì—­ì— ì •ì˜ëœ fetch wrapperë¼ê³  ê°€ì •í•©ë‹ˆë‹¤.
                const res = await get(ROOMS_READ_URI);
                if (!res.ok) throw new Error('Failed to load rooms');
                const rooms = await res.json();
                renderRooms(rooms);

                // ì´ˆê¸° ë¡œë“œ í›„ ì›¹ì†Œì¼“ ì—°ê²° ì‹œì‘
                connect();

            } catch (e) {
                console.error('Error loading rooms:', e);
            }
        }

        function renderRooms(rooms) {
            roomsList.innerHTML = '';
            if (!rooms || rooms.length === 0) {
                roomsList.innerHTML = `<li class="list-group-item bg-transparent text-center text-muted">No rooms available. Be the first to create one!</li>`;
                return;
            }
            rooms.forEach(r => {
                // ğŸŸ¢ DTO êµ¬ì¡°ì— ë§ì¶° participantsCount í•„ë“œ ì‚¬ìš©
                const participantCount = r.participantsCount ?? 0;

                const li = document.createElement('li');
                li.className = 'list-group-item room-item d-flex justify-content-between align-items-center';
                li.onclick = () => window.location.href = `/pages/rooms/${r.id}`;
                li.setAttribute('data-room-id', r.id);

                li.innerHTML = `
                  <div class="flex-grow-1">
                    <div class="fw-bold d-flex align-items-center">
                        ${escapeHtml(r.name)}
                        <span class="room-participant-count">
                           <i class="bi bi-person-fill"></i>
                           <span class="participant-count-value">${participantCount}</span>
                        </span>
                    </div>
                    <div class="small text-muted mt-1">
                        <i class="bi bi-tag-fill me-1"></i> #${r.id}
                        <span class="ms-3 d-none d-sm-inline">
                            <i class="bi bi-person-fill me-1"></i> Created by ${r.maker ?? 'system'}
                        </span>
                    </div>
                  </div>
                  <div>
                    <button class="btn btn-sm btn-enter" data-id="${r.id}" onclick="event.stopPropagation(); window.location.href = '/pages/rooms/${r.id}'">Enter</button>
                  </div>
                `;
                roomsList.appendChild(li);
            });
        }

        // ğŸš© ìˆ˜ì • ì‹œì‘: ë²„íŠ¼ ìš”ì†Œë¥¼ ë¨¼ì € ì°¾ìŠµë‹ˆë‹¤.
        const createRoomButton = document.getElementById('btn-create-room');
        const createRoomSubmit = document.getElementById('create-room-submit');

        // ------------------------------------
        // Create room modal event handling
        // ------------------------------------

        if (createRoomButton) {
            createRoomButton.addEventListener('click', () => {
                modal.show();
                document.getElementById('new-room-name').value = '';
                setTimeout(() => document.getElementById('new-room-name').focus(), 200);
            });
        }

        if (createRoomSubmit) {
            createRoomSubmit.addEventListener('click', async () => {
                const name = document.getElementById('new-room-name').value.trim();
                if (!name) return alert('Room name required');
                try {
                    const createdBy = payload ? Number(payload.sub) : null;
                    // post() í•¨ìˆ˜ëŠ” ì „ì—­ì— ì •ì˜ëœ fetch wrapperë¼ê³  ê°€ì •í•©ë‹ˆë‹¤.
                    const res = await post(ROOMS_CREATE_URI, { name, createdBy });

                    if (res.ok) {
                        modal.hide();
                        const body = await res.json();
                        if (body && body.id) {
                            // ë°© ìƒì„± í›„ ë°”ë¡œ í•´ë‹¹ ë°©ìœ¼ë¡œ ì´ë™
                            window.location.href = `/pages/rooms/${body.id}`;
                        } else {
                            // ë°© ìƒì„±ì€ ëì§€ë§Œ idê°€ ì—†ìœ¼ë©´ ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨
                            await loadRooms();
                        }
                    } else {
                        const text = await res.text();
                        if (res.status === 403) {
                            alert('Create failed: You do not have permission (ROLE_ADMIN required).');
                        } else {
                            alert('Create failed: ' + text);
                        }
                    }
                } catch (e) {
                    console.error('Error creating room:', e);
                    alert('Create failed due to network error.');
                }
            });
        }

        // escape helper (XSS ë°©ì§€)
        function escapeHtml(s) {
            if (!s) return '';
            // HTML ì—”í‹°í‹° ì¹˜í™˜: &, <, >, ", '
            return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;');
        }

        // initial load and connect
        loadRooms();

        // í˜ì´ì§€ë¥¼ ë²—ì–´ë‚  ë•Œ STOMP ì—°ê²° í•´ì œ (Clean up)
        window.onbeforeunload = function() {
            if (stompClient && stompClient.connected) {
                stompClient.disconnect(() => {
                    console.log("STOMP Connection disconnected.");
                });
            }
        };
    })();
</script>
</body>
</html>