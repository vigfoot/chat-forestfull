<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <script th:replace="~{/layout/config.html}"></script>

    <style>
        /* Dark Theme overrides for the list card */
        .cf-rooms-card {
            background-color: var(--cf-dark-bg-secondary) !important;
            border: 1px solid var(--cf-border-color);
            color: var(--cf-text-primary);
        }

        .cf-rooms-card .list-group-item {
            background-color: transparent !important; /* Make items inherit card color */
            border-color: var(--cf-border-color);
            color: var(--cf-text-primary);
            padding: 1.25rem 1rem;
            cursor: pointer;
        }

        .cf-rooms-card .text-muted {
            color: var(--cf-text-secondary) !important;
        }

        /* Styling for the Primary Enter Button */
        .btn-enter {
            background-color: var(--cf-accent-primary) !important;
            border-color: var(--cf-accent-primary) !important;
            color: var(--cf-dark-bg-primary) !important;
            font-weight: bold;
            min-width: 90px;
        }

        .btn-enter:hover {
            filter: brightness(1.1);
        }

        /* Room participant count style */
        .room-participant-count {
            color: var(--cf-accent-primary);
            font-weight: bold;
            margin-left: 10px;
            font-size: 0.9em;
        }
    </style>

    <title>Chat ForestFull | Rooms</title>
</head>
<body class="d-flex flex-column min-vh-100">

<header th:replace="~{/layout/header.html}"></header>

<main class="container py-5 flex-grow-1">
    <div class="row justify-content-center">
        <div class="col-sm-12 col-md-10 col-lg-8">
            <div class="card cf-rooms-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3"
                     style="border-color: var(--cf-border-color) !important;">
                    <h4 class="mb-0 fw-bold">üå≥Room</h4>

                    <div class="d-flex align-items-center">
                        <small class="text-muted me-3" id="user-info">Loading user...</small>
                        <div sec:authorize="hasRole('ROLE_ADMIN')">
                            <button id="btn-create-room" class="btn btn-sm btn-primary fw-bold">
                                <i class="bi bi-plus-lg me-1"></i> Create Room
                            </button>
                        </div>
                    </div>
                </div>

                <ul id="rooms-list" class="list-group list-group-flush">
                </ul>

                <div class="mt-4 text-muted small text-center">
                    <i class="bi bi-info-circle me-1"></i> Click a room name or the 'Enter' button to join.
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{/layout/footer.html}"></footer>

<div class="modal fade" id="createRoomModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content cf-rooms-card">
            <div class="modal-header border-bottom" style="border-color: var(--cf-border-color) !important;">
                <h5 class="modal-title fw-bold">Create New Room</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input id="new-room-name" class="form-control" placeholder="Room name (required)"
                       style="background-color: var(--cf-dark-bg-primary); color: var(--cf-text-primary); border-color: var(--cf-border-color);"/>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="create-room-submit" class="btn btn-primary fw-bold">Create</button>
            </div>
        </div>
    </div>
</div>

<script src="/webjars/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/2.3.4/stomp.min.js"></script>
<script>
    (function () {
        const payload = getJwtPayload(); // global function
        const userDisplay = payload ? (payload.displayName || payload.name || ('#' + payload.sub)) : 'Guest';
        document.getElementById('user-info').innerText = `Logged in as ${userDisplay}`;

        const roomsList = document.getElementById('rooms-list');
        const modal = new bootstrap.Modal(document.getElementById('createRoomModal'));

        // üü¢ STOMP Client Ï†ïÏùò Î∞è ÏÑ§Ï†ï
        let stompClient = null;
        const participantsTopic = '/topic/rooms/participants';
        // üö© API URI ÏÉÅÏàò Ï†ïÏùò
        const ROOMS_READ_URI = '/api/chat/rooms';
        const ROOMS_CREATE_URI = '/api/admin/chat/rooms'; // üö® Î≥ÄÍ≤ΩÎêú Í¥ÄÎ¶¨Ïûê URI

        // ------------------------------------
        // ÏõπÏÜåÏºì Ïó∞Í≤∞ Î∞è Íµ¨ÎèÖ Î°úÏßÅ
        // ------------------------------------
        function connect() {
            if (stompClient && stompClient.connected) {
                return;
            }

            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.debug = null;

            stompClient.connect({}, (frame) => {
                console.log('STOMP Connection established.');
                stompClient.subscribe(participantsTopic, (message) => {
                    const update = JSON.parse(message.body);
                    handleParticipantUpdate(update);
                });

            }, (error) => {
                console.error('STOMP Connection failed:', error);
                setTimeout(connect, 5000);
            });
        }

        function handleParticipantUpdate(update) {
            const roomId = update.roomId;
            const newCount = update.count;
            const roomItem = document.querySelector(`li[data-room-id="${roomId}"]`);

            if (roomItem) {
                const countElement = roomItem.querySelector('.participant-count-value');
                if (countElement) {
                    countElement.innerText = newCount;
                }
            }
        }
        // ------------------------------------

        async function loadRooms() {
            try {
                // Î∞© Î™©Î°ù Ï°∞Ìöå URI ÏÇ¨Ïö©
                const res = await get(ROOMS_READ_URI);
                if (!res.ok) throw new Error('Failed to load rooms');
                const rooms = await res.json();
                renderRooms(rooms);

                // Ï¥àÍ∏∞ Î°úÎìú ÌõÑ ÏõπÏÜåÏºì Ïó∞Í≤∞ ÏãúÏûë
                connect();

            } catch (e) {
                console.error(e);
            }
        }

        function renderRooms(rooms) {
            roomsList.innerHTML = '';
            if (!rooms || rooms.length === 0) {
                roomsList.innerHTML = `<li class="list-group-item bg-transparent text-center text-muted">No rooms available. Be the first to create one!</li>`;
                return;
            }
            rooms.forEach(r => {
                const participantCount = r.participantsCount ?? 0;

                const li = document.createElement('li');
                li.className = 'list-group-item room-item d-flex justify-content-between align-items-center';
                li.onclick = () => window.location.href = `/pages/rooms/${r.id}`;
                li.setAttribute('data-room-id', r.id);

                li.innerHTML = `
                  <div class="flex-grow-1">
                    <div class="fw-bold d-flex align-items-center">
                        ${escapeHtml(r.name)}
                        <span class="room-participant-count">
                           <i class="bi bi-person-fill"></i>
                           <span class="participant-count-value">${participantCount}</span>
                        </span>
                    </div>
                    <div class="small text-muted mt-1">
                        <i class="bi bi-tag-fill me-1"></i> #${r.id}
                        <span class="ms-3 d-none d-sm-inline">
                            <i class="bi bi-person-fill me-1"></i> Created by ${r.createdBy ?? 'system'}
                        </span>
                    </div>
                  </div>
                  <div>
                    <button class="btn btn-sm btn-enter" data-id="${r.id}" onclick="event.stopPropagation(); window.location.href = '/pages/rooms/${r.id}'">Enter</button>
                  </div>
                `;
                roomsList.appendChild(li);
            });
        }

        // üö© ÏàòÏ†ï ÏãúÏûë: Î≤ÑÌäº ÏöîÏÜåÎ•º Î®ºÏ†Ä Ï∞æÏäµÎãàÎã§.
        const createRoomButton = document.getElementById('btn-create-room');
        const createRoomSubmit = document.getElementById('create-room-submit');

        // ------------------------------------
        // Create room modal event handling
        // ------------------------------------

        // üü¢ Null Ï≤¥ÌÅ¨ 1: createRoomButtonÏù¥ Ï°¥Ïû¨Ìï† ÎïåÎßå Î¶¨Ïä§ÎÑà Îì±Î°ù
        if (createRoomButton) {
            createRoomButton.addEventListener('click', () => {
                modal.show();
                document.getElementById('new-room-name').value = '';
                setTimeout(() => document.getElementById('new-room-name').focus(), 200);
            });
        }

        // üü¢ Null Ï≤¥ÌÅ¨ 2: createRoomSubmit Î≤ÑÌäºÏùÄ Î™®Îã¨ ÎÇ¥Î∂ÄÏóê ÏûàÏßÄÎßå,
        //   modalÏù¥ sec:authorize Ïô∏Î∂ÄÏóê ÏûàÏúºÎØÄÎ°ú DOMÏóê Ï°¥Ïû¨Ìï† Í∞ÄÎä•ÏÑ±Ïù¥ ÎÜíÏùå.
        //   ÌïòÏßÄÎßå ÏïàÏ†ÑÏùÑ ÏúÑÌï¥, Î≤ÑÌäºÏùÑ Ï∞æÏïÑÏÑú Î¶¨Ïä§ÎÑàÎ•º Îì±Î°ùÌï©ÎãàÎã§.
        if (createRoomSubmit) {
            createRoomSubmit.addEventListener('click', async () => {
                const name = document.getElementById('new-room-name').value.trim();
                if (!name) return alert('Room name required');
                try {
                    const createdBy = payload ? Number(payload.sub) : null;
                    const res = await post(ROOMS_CREATE_URI, { name, createdBy });
                    if (res.ok) {
                        modal.hide();
                        const body = await res.json();
                        if (body && body.id) {
                            window.location.href = `/pages/rooms/${body.id}`;
                        } else {
                            await loadRooms();
                        }
                    } else {
                        const text = await res.text();
                        if (res.status === 403) {
                            alert('Create failed: You do not have permission (ROLE_ADMIN required).');
                        } else {
                            alert('Create failed: ' + text);
                        }
                    }
                } catch (e) {
                    console.error(e);
                    alert('Create failed');
                }
            });
        }

        // escape helper
        function escapeHtml(s) {
            if (!s) return '';
            return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;');
        }

        // initial load and connect
        loadRooms();

        // ÌéòÏù¥ÏßÄÎ•º Î≤óÏñ¥ÎÇ† Îïå STOMP Ïó∞Í≤∞ Ìï¥Ï†ú (Clean up)
        window.onbeforeunload = function() {
            if (stompClient && stompClient.connected) {
                stompClient.disconnect(() => {
                    console.log("STOMP Connection disconnected.");
                });
            }
        };
    })();
</script>
</body>
</html>