<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <script th:replace="~{/layout/config.html}"></script>

    <style>
        /* Admin User Management 전용 스타일 */
        body {
            background-color: var(--cf-dark-bg-primary); /* Dark Theme Background */
            color: var(--cf-text-primary);
        }

        /* 테이블 스타일 */
        .table {
            --bs-table-bg: var(--cf-dark-bg-secondary); /* 테이블 배경 */
            --bs-table-color: var(--cf-text-primary); /* 테이블 텍스트 색상 */
            --bs-table-striped-bg: #2a2a2a; /* 줄무늬 배경 */
            border: 1px solid var(--cf-border-color);
        }

        /* 테이블 헤더 스타일 */
        .table thead {
            background-color: var(--cf-dark-bg-tertiary) !important;
            border-bottom: 2px solid var(--cf-accent-primary);
        }

        .table thead th {
            color: var(--cf-text-primary);
            font-weight: bold;
        }

        /* 입력 필드 (역할 수정) 스타일 */
        .table .form-control {
            background-color: var(--cf-dark-bg-tertiary);
            color: var(--cf-text-primary);
            border: 1px solid var(--cf-border-color);
        }
    </style>

    <title>Chat ForestFull | User Management</title>
</head>
<body class="d-flex flex-column min-vh-100">

<header th:replace="~{/layout/header.html :: header}"></header>

<main class="container py-5 flex-grow-1">
    <div class="row justify-content-center">
        <div class="col-sm-12 col-lg-10">
            <h2 class="text-center mb-5 fw-bold" style="color: var(--cf-accent-primary);">
                <i class="bi bi-people-fill me-2"></i> User Management
            </h2>

            <div class="d-flex justify-content-between mb-3">
                <button class="btn btn-sm btn-primary" onclick="loadUsers()">
                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh User List
                </button>
                <a th:href="@{/pages/admin/dashboard}" class="btn btn-sm btn-secondary">
                    <i class="bi bi-arrow-left-circle me-1"></i> Back to Dashboard
                </a>
            </div>

            <div class="table-responsive shadow-lg rounded" style="border: 1px solid var(--cf-border-color);">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                    <tr>
                        <th style="width: 20%;">User ID</th>
                        <th style="width: 30%;">Username</th>
                        <th style="width: 30%;">Roles (CSV)</th>
                        <th style="width: 20%;">Actions</th>
                    </tr>
                    </thead>
                    <tbody id="admin-users-tbody">
                    <tr><td colspan="4" class="text-center p-4 text-muted">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</main>

<footer th:replace="~{/layout/footer.html}"></footer>

<script>
    async function loadUsers() {
        try {
            const res = await get('/admin/users'); // GET 함수는 script.js에 정의되어 있다고 가정
            if (!res.ok) {
                showAlert('Failed to fetch user list from server.', 'danger');
                return;
            }
            const users = await res.json();

            const tbody = document.getElementById('admin-users-tbody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-muted">No users found.</td></tr>';
                return;
            }

            users.forEach(user => {
                const tr = document.createElement('tr');
                // ID는 숨기고, Username과 ID를 분리하여 표시
                tr.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td><input type="text" class="form-control form-control-sm" value="${user.roles || ''}" id="roles-${user.id}"></td>
                    <td>
                        <button class="btn btn-sm btn-success me-1" onclick="updateRoles('${user.id}')" title="Save Roles">
                            <i class="bi bi-check-lg"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')" title="Delete User">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            showAlert(`Successfully loaded ${users.length} users.`, 'success');

        } catch (err) {
            console.error('Error processing user list:', err);
            showAlert('Failed to connect to the server or process data.', 'danger');
        }
    }

    async function updateRoles(id) {
        const roles = document.getElementById(`roles-${id}`).value;
        try {
            // PUT 함수는 script.js에 정의되어 있다고 가정
            const data = await put(`/admin/users/${id}/roles`, {roles});
            if (data.status === 200) {
                showAlert(data.message || 'Roles updated successfully.', 'success');
            } else {
                showAlert(data.message || 'Update failed (Server message).', 'warning');
            }
        } catch (err) {
            console.error('Update error:', err);
            showAlert('Update failed (Communication error).', 'danger');
        }
    }

    async function deleteUser(id) {
        if (!confirm(`Are you sure you want to delete user ID ${id}? This action cannot be undone.`)) {
            return;
        }
        try {
            // DEL 함수는 script.js에 정의되어 있다고 가정
            const data = await del(`/admin/users/${id}`);
            if (data.status === 200) {
                showAlert(data.message || `User ID ${id} deleted successfully.`, 'success');
                loadUsers(); // Refresh list
            } else {
                showAlert(data.message || 'Delete failed (Server message).', 'warning');
            }
        } catch (err) {
            console.error('Delete error:', err);
            showAlert('Delete failed (Communication error).', 'danger');
        }
    }

    // 페이지 로드 시 목록 가져오기
    window.onload = loadUsers;
</script>

</body>
</html>