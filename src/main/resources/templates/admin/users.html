<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Users Management</title>
    <link rel="stylesheet" href="/webjars/bootstrap/5.3.8/css/bootstrap.min.css">
    <script src="/webjars/bootstrap/5.3.8/js/bootstrap.bundle.min.js"></script>
    <script src="/js/script.js"></script> <!-- 공통 fetch 함수 로드 -->
</head>
<body class="bg-light">

<div class="container py-5">
    <h2 class="text-center mb-4">관리자 회원 관리</h2>

    <table class="table table-striped table-bordered shadow-sm">
        <thead class="table-dark">
        <tr>
            <th>Username</th>
            <th>Roles (comma-separated)</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="admin-users-tbody"></tbody>
    </table>

    <button class="btn btn-primary" onclick="loadUsers()">Refresh</button>
</div>

<script>
    function loadUsers() {
        get('/admin/users')
            .then(res => res.json())
            .then(users => {
                const tbody = document.getElementById('admin-users-tbody');
                tbody.innerHTML = '';
                users.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                <td>${user.name}</td>
                <td><input type="text" class="form-control" value="${user.roles}" id="roles-${user.id}"></td>
                <td>
                    <button class="btn btn-sm btn-success me-1" onclick="updateRoles('${user.id}')">Update</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')">Delete</button>
                </td>
            `;
                    tbody.appendChild(tr);
                });
            }).catch(err => {
            console.error('사용자 목록 처리 오류:', err);
            alert('사용자 목록을 가져오지 못했습니다.');
        });
    }

    function updateRoles(id) {
        const roles = document.getElementById(`roles-${id}`).value;
        put(`/admin/users/${id}/roles`, {roles}).then(data => {
            alert(data.message || '업데이트 완료');
        }).catch(err => {
            console.error('업데이트 처리 오류:', err);
            alert('업데이트 실패 (서버 오류)');
        });
    }

    function deleteUser(id) {
        del(`/admin/users/${id}`).then(data => {
            alert(data.message || '삭제 완료');
            loadUsers();
        }).catch(err => {
            console.error('삭제 처리 오류:', err);
            alert('삭제 실패 (서버 오류)');
        });
    }

    // 페이지 로드 시 목록 가져오기
    window.onload = loadUsers;
</script>

</body>
</html>
