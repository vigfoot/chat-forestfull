<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <script th:replace="~{/layout/config.html}"></script>

    <title>Chat Forestfull | Sign In</title>

    <script>
        /* Login Page Routes */
        const ADMIN_PAGE = '/pages/admin/dashboard';
        const ROOMS_PAGE = '/pages/rooms';
        const LOGIN_API = '/api/auth/login';

        const payload = getJwtPayload();
        if (payload?.roles?.includes("ROLE_ADMIN")) {
            window.location.replace(ADMIN_PAGE);
        } else if(payload?.roles?.startsWith("ROLE_")){
            window.location.replace(ROOMS_PAGE);
        }

        document.addEventListener("DOMContentLoaded", () => {
            const passwordInput = document.getElementById('password');
            if (passwordInput) {
                passwordInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        login();
                    }
                });
            }
        });

        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                showModal("Input Error", "Please enter both ID and Password.", null);
                return;
            }

            const joinBtn = document.querySelector('button.btn-primary');
            joinBtn.disabled = true;

            try {
                const loginResp = await post(LOGIN_API, {username, password});

                if (loginResp.ok) {
                    const payload = getJwtPayload();
                    const targetPage = payload.roles?.includes('ROLE_ADMIN') ? ADMIN_PAGE : ROOMS_PAGE;

                    showModal("Login Successful", "Welcome! Redirecting to the service.", () => {
                        window.location.replace(targetPage);
                    });

                } else if (loginResp.status === 401 || loginResp.status === 404) {
                    showModal("Login Failed", "â— The ID or password you entered is incorrect.", () => window.location.reload());

                } else {
                    showModal("Login Failed", `âŒ Failed to log in due to a server error. (Status: ${loginResp.status})`, () => window.location.reload());
                }
            } catch (err) {
                console.error(err);
                showModal("Communication Error", "âš ï¸ An issue occurred while communicating with the server. Please check your network status.", () => window.location.reload());
            } finally {
                joinBtn.disabled = false;
            }
        }
    </script>

    <style>
        /* 1. ë°°ê²½ ë¡œê³  ì ìš© ë° ë¶ˆíˆ¬ëª… ì²˜ë¦¬ */
        body {
            background-color: var(--cf-dark-bg-primary, #121212);
            background-image: url('/images/forestfull.svg');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 90%;
            background-attachment: fixed;
        }

        /* 2. ì¹´ë“œ ë°°ê²½ìƒ‰ì„ ë°˜íˆ¬ëª…í•˜ê²Œ ì„¤ì • */
        .card.bg-secondary-theme {
            background-color: rgba(30, 30, 30, 0.9) !important;
            backdrop-filter: blur(5px);
        }

        /* 3. ì…ë ¥ í•„ë“œ ë°°ê²½ìƒ‰ë„ ë°˜íˆ¬ëª…í•˜ê²Œ ì„¤ì • */
        .form-control {
            background-color: rgba(42, 42, 42, 0.85) !important;
            border-color: rgba(56, 56, 56, 0.5) !important;
        }

        /* í¬ì»¤ìŠ¤ ì‹œì—ë„ íˆ¬ëª…ë„ ìœ ì§€ */
        .form-control:focus {
            background-color: rgba(42, 42, 42, 0.85) !important;
        }

        /* 4. Jump back into the conversation. ë¬¸êµ¬ í¬ê¸° ì¡°ì • */
        .login-subtitle {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--cf-text-secondary);
        }

        /* 5. ì¸ë¼ì¸ ë¡œê³  ìŠ¤íƒ€ì¼ ë° ì¤„ë°”ê¿ˆ ë°©ì§€ */
        .chat-logo-container {
            /* ğŸš© NEW: Flexboxë¡œ ìì‹ ìš”ì†Œ(ì´ë¯¸ì§€+í…ìŠ¤íŠ¸)ë¥¼ í•œ ì¤„ì— ì •ë ¬ */
            display: flex;
            align-items: center;
            justify-content: center;
            /* ğŸš© NEW: ì»¨í…Œì´ë„ˆê°€ ì¤„ë°”ê¿ˆë˜ëŠ” ê²ƒì„ ë°©ì§€ */
            white-space: nowrap;
            overflow: hidden; /* ë„˜ì¹˜ëŠ” ë‚´ìš© ìˆ¨ê¸°ê¸° (ì¤„ë°”ê¿ˆì´ ì•ˆë˜ë„ë¡ ê°•ì œ) */
            text-overflow: ellipsis;
            /* í…ìŠ¤íŠ¸ í¬ê¸° */
            font-size: var(--bs-fs-1); /* ê¸°ë³¸ í¬ê¸°ëŠ” fs-1 ìœ ì§€ */
        }

        /* ğŸš© NEW: ëª¨ë°”ì¼ í™˜ê²½ì—ì„œ í…ìŠ¤íŠ¸ í¬ê¸° ì¶•ì†Œ */
        @media (max-width: 576px) {
            .chat-logo-container {
                /* ì‘ì€ í™”ë©´ì—ì„œ í…ìŠ¤íŠ¸ í¬ê¸°ë¥¼ h4(1.5rem) ì •ë„ë¡œ ì¤„ì—¬ì„œ í•œ ì¤„ì— ë“¤ì–´ê°€ë„ë¡ í•¨ */
                font-size: 1.5rem !important;
            }
            .inline-logo {
                /* í…ìŠ¤íŠ¸ í¬ê¸°ì— ë§ì¶° ë¡œê³  ë†’ì´ë„ ì¤„ì„ */
                height: 30px !important;
            }
        }

        .inline-logo {
            height: 40px;
            vertical-align: sub;
            margin-right: 0;
            padding: 0;
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">

<main class="container my-auto">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card bg-secondary-theme mx-auto" style="max-width: 800px; padding: 40px;">
                <div class="card-body p-0">

                    <div class="text-center mb-4">
                        <div class="fw-bold d-block chat-logo-container" style="color: var(--cf-text-primary);">
                            <img src="/images/forestfull.svg" alt="Chat ForestFull Logo" class="inline-logo">
                            Chat ForestFull
                        </div>

                        <p class="login-subtitle mt-2" style="color: var(--cf-text-secondary);">Jump back into the conversation.</p>
                    </div>

                    <div class="mb-3">
                        <label for="username" class="form-label visually-hidden">Username</label>
                        <input id="username" type="text" class="form-control form-control-lg" placeholder="Enter your ID">
                    </div>
                    <div class="mb-4">
                        <label for="password" class="form-label visually-hidden">Password</label>
                        <input id="password" type="password" class="form-control form-control-lg" placeholder="Enter your password"
                               onkeydown="if(event.key === 'Enter') login()">
                    </div>

                    <button type="button" class="btn btn-primary btn-lg w-100 mb-3 fw-bold" onclick="login()">
                        Sign In
                    </button>

                    <div class="text-center">
                        <p class="text-muted mb-0" style="color: var(--cf-text-secondary) !important;">Don't have an account?</p>
                        <a href="/pages/signup" class="text-decoration-none fw-bold" style="color: var(--cf-accent-primary);">
                            Sign Up
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{/layout/footer.html}"></footer>
</body>
</html>