<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <script th:replace="~{/layout/config.html}"></script>
    <title>Chat Forestfull | Login</title>
    <script>
        /* Login Page Routes */
        const ADMIN_PAGE = '/pages/admin/dashboard';
        const ROOMS_PAGE = '/pages/rooms';
        const LOGIN_API = '/api/auth/login';
        const SIGNUP_API = '/api/auth/signup';

        document.addEventListener("DOMContentLoaded", () => {
            // 1. Îπ†Î•∏ ÎùºÏö∞ÌåÖÏùÑ ÏúÑÌïú Ïø†ÌÇ§ Ï≤¥ÌÅ¨ (DOMContentLoadedÏóêÏÑú Ìïú Î≤à Ïã§Ìñâ)
            const payload = getJwtPayload();
            if (payload?.roles?.includes("ROLE_ADMIN")) {
                window.location.replace(ADMIN_PAGE);
            } else if(payload?.roles?.startsWith("ROLE_")){
                window.location.replace(ROOMS_PAGE);
            }

            // 2. **[FIX]** password ÏûÖÎ†• ÌïÑÎìúÏóê Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
            const passwordInput = document.getElementById('password');
            if (passwordInput) {
                passwordInput.addEventListener('keydown', (event) => {
                    // ÌëúÏ§ÄÏ†ÅÏù∏ key ÏÜçÏÑ± Ï≤¥ÌÅ¨
                    if (event.key === 'Enter') {
                        event.preventDefault(); // Í∏∞Î≥∏ Ìèº Ï†úÏ∂ú Î∞©ÏßÄ
                        loginOrSignup();
                    }
                });
            }
        });

        // async Ìï®ÏàòÎäî DOMContentLoaded Î∞îÍπ•Ïóê Ï†ïÏùòÌïòÏó¨ Ï†ÑÏó≠Ï†ÅÏúºÎ°ú Ï†ëÍ∑º Í∞ÄÎä•ÌïòÎèÑÎ°ù Ïú†ÏßÄ
        async function loginOrSignup() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                showModal("Input Error", "Please enter both ID and Password.", null);
                return;
            }

            const joinBtn = document.querySelector('button.btn-slack-primary');
            joinBtn.disabled = true;

            // showLoadingModal();

            try {
                // 1. Attempt Login
                const loginResp = await post(LOGIN_API, {username, password});

                if (loginResp.ok) {
                    const payload = getJwtPayload();
                    const targetPage = payload.roles?.includes('ROLE_ADMIN') ? ADMIN_PAGE : ROOMS_PAGE;

                    // hideLoadingModal();

                    showModal("Login Successful", "Welcome! Redirecting to the service.", () => {
                        window.location.replace(targetPage);
                    });
                    return;

                } else if (loginResp.status === 401) {
                    showModal("Login Failed", "‚ùó The password you entered is incorrect. Please try again.", null);

                } else if (loginResp.status === 400) {
                    const signupPrompt = `
                    <p>The user ID <strong>${username}</strong> was not found.</p>
                    <p>Would you like to create a new account now?</p>
                `;

                    showModal("Account Not Found", signupPrompt, async () => {
                        const signupResp = await post(SIGNUP_API, {name: username, password: password});

                        if (signupResp.ok) {
                            showModal("Sign Up Complete", "üéâ Account successfully created. Attempting to log you in...", async () => {
                                const finalLoginResp = await post(LOGIN_API, {username, password});

                                if (finalLoginResp.ok) {
                                    const payload = getJwtPayload();
                                    const targetPage = payload.roles?.includes('ROLE_ADMIN') ? ADMIN_PAGE : ROOMS_PAGE;
                                    window.location.replace(targetPage);
                                } else {
                                    showModal("Critical Error", "Account was created, but immediate login failed.", null);
                                }
                            });

                        } else if (signupResp.status === 409) {
                            showModal("Sign Up Failed", "‚ùó The username already exists.", null);
                        } else {
                            showModal("Sign Up Failed", "‚ùå Failed to sign up due to an unknown server error.", null);
                        }
                    });
                } else {
                    showModal("Login Failed", `‚ùå Failed to log in due to a server error. (Status: ${loginResp.status})`, null);
                }
            } catch (err) {
                console.error(err);
                showModal("Communication Error", "‚ö†Ô∏è An issue occurred while communicating with the server. Please check your network status.", null);
            } finally {
                // hideLoadingModal();
                joinBtn.disabled = false;
            }
        }
    </script>
    <style>
        /* ... (styles are the same) ... */
    </style>
</head>
<body class="bg-slack-light d-flex flex-column min-vh-100">

<main class="container my-auto">
    <div class="row justify-content-center">
        <div class="col-12">

            <div class="text-center mb-5 mt-5">
                <span class="slack-logo-text">ForestFull</span>
                <p class="text-muted mt-2 fw-semibold">Sign in to your workspace or create an account.</p>
            </div>

            <div class="card login-card-slack mx-auto">
                <div class="card-body p-0">
                    <h2 class="h4 text-center mb-4 fw-bold">Sign in with your Email Address</h2>

                    <div class="mb-3">
                        <label for="username" class="form-label visually-hidden">Username</label>
                        <input id="username" type="text" class="form-control form-control-lg" placeholder="Enter your ID">
                    </div>
                    <div class="mb-4">
                        <label for="password" class="form-label visually-hidden">Password</label>
                        <input id="password" type="password" class="form-control form-control-lg" placeholder="Enter your password">
                    </div>

                    <button type="button" class="btn btn-slack-primary btn-lg w-100 mb-4 fw-bold" onclick="loginOrSignup()">
                        Join
                    </button>
                </div>
            </div>

        </div>
    </div>
</main>

<footer th:replace="~{/layout/footer.html}"></footer>
</body>
</html>