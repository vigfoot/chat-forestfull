<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.forestfull.chat.ChatRoomMapper">
    <select id="findAll" resultType="com.forestfull.chat.ChatDTO$Room">
        SELECT id
             , name
             , created_by
             , created_at
             , updated_at
        FROM chat_forestfull.rooms
        ORDER BY id DESC
    </select>

    <select id="findById" parameterType="long" resultType="com.forestfull.chat.ChatDTO$Room">
        SELECT id
               , name
               , created_by
               , created_at
               , updated_at
        FROM chat_forestfull.rooms
        WHERE id = #{id}
    </select>
    <select id="findParticipants" parameterType="long" resultType="com.forestfull.chat.ChatDTO$Participant">
        SELECT m.id AS memberId
             , m.display_name
             , m.profile_image
        FROM chat_forestfull.member_rooms mr
                 JOIN chat_forestfull.member m ON mr.member_id = m.id
        WHERE mr.room_id = #{roomId}
        ORDER BY mr.joined_at ASC
    </select>

    <select id="existsMemberInRoom" resultType="boolean">
        SELECT COUNT(*) FROM chat_forestfull.member_rooms WHERE room_id = #{roomId} AND member_id = #{memberId}
    </select>

    <insert id="saveRoom" parameterType="com.forestfull.chat.ChatDTO$Room" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO chat_forestfull.rooms(name, created_by)
        VALUES(#{name}, #{createdBy})
    </insert>

    <insert id="joinRoom" parameterType="com.forestfull.member.MemberDTO$Room">
        INSERT INTO chat_forestfull.member_rooms(room_id, member_id, joined_at)
        VALUES(#{roomId}, #{memberId}, NOW())
        ON DUPLICATE KEY UPDATE joined_at = NOW()
    </insert>

    <delete id="leaveRoom">
        DELETE FROM chat_forestfull.member_rooms WHERE room_id = #{roomId} AND member_id = #{memberId}
    </delete>
</mapper>
