<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.forestfull.chat.room.ChatRoomMapper">
    <select id="findAllRooms" resultType="com.forestfull.chat.ChatDTO$Room">
        SELECT r.id, r.name, m.display_name AS maker, r.created_at, r.updated_at
        FROM chat_forestfull.chat_room r
            JOIN chat_forestfull.member m ON r.created_by = m.id
        ORDER BY updated_at DESC
    </select>

    <select id="findRoomById" parameterType="long" resultType="com.forestfull.chat.ChatDTO$Room">
        SELECT r.id, r.name, m.display_name AS maker, r.created_at, r.updated_at
        FROM chat_forestfull.chat_room r
                 JOIN chat_forestfull.member m ON r.created_by = m.id
        WHERE r.id = #{roomId}
    </select>

    <insert id="createRoom" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO chat_forestfull.chat_room (name, created_by)
        VALUES (#{name}, #{memberId})
    </insert>

    <delete id="deleteRoom" parameterType="long">
        DELETE FROM chat_forestfull.chat_room WHERE id = #{roomId}
    </delete>

    <select id="findParticipants" parameterType="long" resultType="com.forestfull.chat.ChatDTO$Participant">
        SELECT
            cp.room_id
            , m.name AS username
            , m.display_name
            , m.profile_image
        FROM chat_forestfull.chat_participant cp
            JOIN chat_forestfull.member m ON cp.member_id = m.id
        WHERE cp.room_id = #{roomId}
    </select>

    <select id="isUserInRoom" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN TRUE ELSE FALSE END
        FROM chat_forestfull.chat_participant
        WHERE room_id = #{roomId}
          AND member_id = #{memberId}
    </select>

    <insert id="addParticipant">
        INSERT INTO chat_forestfull.chat_participant (room_id, member_id, display_name, profile_image)
        SELECT #{roomId}, m.id, m.display_name, m.profile_image
        FROM chat_forestfull.member m
        WHERE m.id = #{memberId}
    </insert>

    <delete id="removeParticipant">
        DELETE FROM chat_forestfull.chat_participant
        WHERE room_id = #{roomId}
          AND member_id = #{memberId}
    </delete>
</mapper>