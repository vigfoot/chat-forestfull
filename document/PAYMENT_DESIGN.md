# \# Chat-Forestfull – Payment \& Point Design

# 

# \## 1. 시스템 개요

# \- 목적: 실시간 커뮤니티에서 포인트 기반 기능 제공 및 결제/권한 관리

# \- 결제 수단: PayPal REST API 연동

# \- 주요 기능:

# &nbsp; - 포인트 구매

# &nbsp; - 임시 매니저 권한 부여

# &nbsp; - 결제 취소/환불 시 포인트 및 권한 회수

# &nbsp; - 감사 로그 기록

# 

# \## 2. 포인트 \& 임시 매니저 권한 구조

# 

# | 항목               | 설명 |

# | ------------------ | ---- |

# | 포인트             | PayPal 결제 후 지급, 특별 채팅 등 사용 가능 |

# | 임시 매니저 권한   | 상위 1~3위 포인트 구매자에게 1주일간 부여 |

# | 권한 사용 제한     | Mute 기능: 1시간, 주 10회 제한 |

# | 특별 채팅 사용     | 사진+텍스트 업로드 시 필요 |

# 

# \## 3. 결제/포인트 흐름

# 

# \### 3.1 결제 완료

# 1\. PayPal Sandbox / Production 승인

# 2\. DB에 결제 기록 저장 (상태: SUCCESS)

# 3\. 포인트 지급

# 4\. 주간 상위 포인트 구매자 순위 집계 → 임시 매니저 권한 부여

# 

# \### 3.2 결제 취소 / 환불

# 1\. PayPal Webhook 이벤트 수신 (`PAYMENT.CAPTURE.REFUNDED`, `PAYMENT.CAPTURE.CANCELLED` 등)

# 2\. DB 업데이트:

# &nbsp;  - 포인트 차감

# &nbsp;  - 임시 매니저 권한 회수

# &nbsp;  - 이미 사용한 권한은 기록으로 남김

# &nbsp;  - 추가 사용 제한

# 3\. 사용자 알림 발송 (채팅 내 공지 또는 모달)

# 

# \### 3.3 권한 만료

# \- 주 단위 집계 후 자동 소멸

# \- 사용 기록 감사 로그에 저장

# 

# \## 4. Webhook 처리

# \- 이벤트 수신: 결제 완료, 취소, 환불 등

# \- 처리 흐름:

# &nbsp; 1. Webhook 이벤트 수신

# &nbsp; 2. 이벤트 타입 확인 (`PAYMENT.CAPTURE.COMPLETED`, `PAYMENT.CAPTURE.REFUNDED`, `PAYMENT.CAPTURE.CANCELLED`)

# &nbsp; 3. DB 업데이트 및 트랜잭션 실행

# &nbsp; 4. 사용자 알림 및 로그 기록

# 

# \## 5. 추가 고려 사항

# \- 주간 순위 집계와 결제 취소 동기화

# \- 포인트/권한 남용 방지 (사용 횟수, 시간 제한, 감사 로그 기록)

# \- 백업 및 복구: 선택 사항

# \- Signature 검증 필수

# \- 동시성 문제 처리

# \- 에러 처리: 초당 1~3회 재시도, 실패 시 사용자 반환 처리

# 

